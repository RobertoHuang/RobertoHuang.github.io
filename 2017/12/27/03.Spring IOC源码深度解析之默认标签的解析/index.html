<!DOCTYPE html>
<html lang=zh>
<head>
    <meta charset="utf-8">
    
    <title>03.Spring IOC源码深度解析之默认标签的解析 | 黄太洪的博客</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
	<meta name="keywords" content="黄太洪的博客,大数据,物联网,云计算IAAS,云计算SAAS,云计算PAAS, Hadoop, 大数据, JavaEE, Java, 物联网, NoSQL, MongoDB, Dubbo, SpringBoot, SpringCloud, Spring, SpringMVC, Hibernate">
    <meta name="description" content="标签解析在Spring的XML配置里面有两大类声明，一个是默认的如&amp;lt;bean id=”test” class=”test.TestBean” /&amp;gt;，另一类就是自定义的如&amp;lt;tx:annotation-driven /&amp;gt;，两种标签的解析方式差异是非常大的。parseBeanDefinitions方法就是用来处理使用哪种方式解析标签，判断是否默认命名空间还是自定义命名空间的办法是">
<meta name="keywords" content="Spring源码深度解析,Spring IOC源码解析,Spring默认标签解析">
<meta property="og:type" content="article">
<meta property="og:title" content="03.Spring IOC源码深度解析之默认标签的解析">
<meta property="og:url" content="http://huangth.com/2017/12/27/03.Spring IOC源码深度解析之默认标签的解析/index.html">
<meta property="og:site_name" content="黄太洪的博客">
<meta property="og:description" content="标签解析在Spring的XML配置里面有两大类声明，一个是默认的如&amp;lt;bean id=”test” class=”test.TestBean” /&amp;gt;，另一类就是自定义的如&amp;lt;tx:annotation-driven /&amp;gt;，两种标签的解析方式差异是非常大的。parseBeanDefinitions方法就是用来处理使用哪种方式解析标签，判断是否默认命名空间还是自定义命名空间的办法是">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="http://oxje1v37b.bkt.clouddn.com/Spring%E6%BA%90%E7%A0%81%E6%B7%B1%E5%BA%A6%E8%A7%A3%E6%9E%90%E5%B0%81%E9%9D%A2.jpg">
<meta property="og:updated_time" content="2018-03-08T14:45:24.240Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="03.Spring IOC源码深度解析之默认标签的解析">
<meta name="twitter:description" content="标签解析在Spring的XML配置里面有两大类声明，一个是默认的如&amp;lt;bean id=”test” class=”test.TestBean” /&amp;gt;，另一类就是自定义的如&amp;lt;tx:annotation-driven /&amp;gt;，两种标签的解析方式差异是非常大的。parseBeanDefinitions方法就是用来处理使用哪种方式解析标签，判断是否默认命名空间还是自定义命名空间的办法是">
<meta name="twitter:image" content="http://oxje1v37b.bkt.clouddn.com/Spring%E6%BA%90%E7%A0%81%E6%B7%B1%E5%BA%A6%E8%A7%A3%E6%9E%90%E5%B0%81%E9%9D%A2.jpg">
    

    

    
        <link rel="icon" href="/css/images/avatar.png" />
    

    <link rel="stylesheet" href="/libs/font-awesome/css/font-awesome.min.css">
    <link rel="stylesheet" href="/libs/open-sans/styles.css">
    <link rel="stylesheet" href="/libs/source-code-pro/styles.css">

    <link rel="stylesheet" href="/css/style.css">

    <script src="/libs/jquery/2.1.3/jquery.min.js"></script>
    
    
        <link rel="stylesheet" href="/libs/lightgallery/css/lightgallery.min.css">
    
    
        <link rel="stylesheet" href="/libs/justified-gallery/justifiedGallery.min.css">
    
    
    
    


</head>

<body>
    <div id="container">
        <header id="header">
    <div id="header-main" class="header-inner">
        <div class="outer" style="margin:0;max-width:none">
            <a href="/" id="logo">
                <i class="logo"></i>
                <span class="site-title">黄太洪的博客</span>
            </a>
            <nav id="main-nav">
                
                    <a class="main-nav-link" href="/.">主页</a>
                
                    <a class="main-nav-link" href="/archives">文章</a>
                
                    <a class="main-nav-link" href="/about">关于作者</a>
                
            </nav>
            
                
                <nav id="sub-nav">
                    <div class="profile" id="profile-nav">
                        <a id="profile-anchor" href="javascript:;">
                            <img class="avatar" src="/css/images/avatar.png" />
                            <i class="fa fa-caret-down"></i>
                        </a>
                    </div>
                </nav>
            
            <div id="search-form-wrap">

    <form class="search-form">
        <input type="text" class="ins-search-input search-form-input" placeholder="搜索" />
        <button type="submit" class="search-form-submit"></button>
    </form>
    <div class="ins-search">
    <div class="ins-search-mask"></div>
    <div class="ins-search-container">
        <div class="ins-input-wrapper">
            <input type="text" class="ins-search-input" placeholder="想要查找什么..." />
            <span class="ins-close ins-selectable"><i class="fa fa-times-circle"></i></span>
        </div>
        <div class="ins-section-wrapper">
            <div class="ins-section-container"></div>
        </div>
    </div>
</div>
<script>
(function (window) {
    var INSIGHT_CONFIG = {
        TRANSLATION: {
            POSTS: '文章',
            PAGES: '页面',
            CATEGORIES: '分类',
            TAGS: '标签',
            UNTITLED: '(未命名)',
        },
        ROOT_URL: '/',
        CONTENT_URL: '/content.json',
    };
    window.INSIGHT_CONFIG = INSIGHT_CONFIG;
})(window);
</script>
<script src="/js/insight.js"></script>

</div>
        </div>
    </div>
    <div id="main-nav-mobile" class="header-sub header-inner">
        <table class="menu outer">
            <tr>
                
                    <td><a class="main-nav-link" href="/.">主页</a></td>
                
                    <td><a class="main-nav-link" href="/archives">文章</a></td>
                
                    <td><a class="main-nav-link" href="/about">关于作者</a></td>
                
                <td>
                    
    <div class="search-form">
        <input type="text" class="ins-search-input search-form-input" placeholder="搜索" />
    </div>

                </td>
            </tr>
        </table>
    </div>
</header>

        <div class="outer" style="max-width:none">
            
                

<aside id="profile">
    <div class="inner profile-inner">
        <div class="base-info profile-block">
            <img id="avatar" src="/css/images/avatar.png" />
            <h2 id="name">黄太洪</h2>
            <h3 id="title">Software Engineer</h3>
            <span id="location"><i class="fa fa-map-marker"></i>FuZhou, China</span>
            <a id="follow" target="_blank" href="https://github.com/RobertoHuang/">关注我</a>
        </div>
        <div class="article-info profile-block">
            <div class="article-info-block">
                5
                <span>文章</span>
            </div>
            <div class="article-info-block">
                10
                <span>标签</span>
            </div>
        </div>
        
        <div class="profile-block social-links">
            <table>
                <tr>
                    
                    
                    <td>
                        <a href="https://github.com/RobertoHuang/" target="_blank" title="github" class=tooltip>
                            <i class="fa fa-github"></i>
                        </a>
                    </td>
                    
                    <td>
                        <a href="/css/images/wechat.jpg" target="_blank" title="wechat" class=tooltip>
                            <i class="fa fa-wechat"></i>
                        </a>
                    </td>
                    
                    <td>
                        <a href="https://weibo.com/u/2978046817?refer_flag=1001030101_" target="_blank" title="weibo" class=tooltip>
                            <i class="fa fa-weibo"></i>
                        </a>
                    </td>
                    
                    <td>
                        <a href="/" target="_blank" title="linkedin" class=tooltip>
                            <i class="fa fa-linkedin"></i>
                        </a>
                    </td>
                    
                </tr>
            </table>
        </div>
        
		<div>
			<iframe frameborder="no" border="0" marginwidth="0" marginheight="0" width="100%" height="52" 
			src="https://music.163.com/outchain/player?type=0&amp;id=2016043382&amp;auto=0&amp;height=32"></iframe>
		</div>
    </div>
</aside>

            
            <section id="main"><article id="post-03.Spring IOC源码深度解析之默认标签的解析" class="article article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
        
        
            <header class="article-header">
                
    
        <h1 class="article-title" itemprop="name">
            03.Spring IOC源码深度解析之默认标签的解析
        </h1>
    

                
                    <div class="article-meta">
                        
    <div class="article-date">
        <i class="fa fa-calendar"></i>
        <a href="/2017/12/27/03.Spring IOC源码深度解析之默认标签的解析/">
            <time datetime="2017-12-27T04:00:00.000Z" itemprop="datePublished">2017-12-27</time>
        </a>
    </div>


                        
    <div class="article-category">
    	<i class="fa fa-folder"></i>
        <a class="article-category-link" href="/categories/Spring源码深度解析/">Spring源码深度解析</a>
    </div>

                        
    <div class="article-tag">
        <i class="fa fa-tag"></i>
        <a class="tag-link" href="/tags/Spring-IOC源码解析/">Spring IOC源码解析</a>, <a class="tag-link" href="/tags/Spring源码深度解析/">Spring源码深度解析</a>, <a class="tag-link" href="/tags/Spring默认标签解析/">Spring默认标签解析</a>
    </div>

                    </div>
                
            </header>
        
        
        <div class="article-entry" itemprop="articleBody">
        
            
            <script src="\assets\js\APlayer.min.js"> </script><h1 id="标签解析"><a href="#标签解析" class="headerlink" title="标签解析"></a>标签解析</h1><p>在Spring的XML配置里面有两大类声明，一个是默认的如&lt;bean id=”test” class=”test.TestBean” /&gt;，另一类就是自定义的如&lt;tx:annotation-driven /&gt;，两种标签的解析方式差异是非常大的。parseBeanDefinitions方法就是用来处理使用哪种方式解析标签，判断是否默认命名空间还是自定义命名空间的办法是使用node.getNamespaceURI()获取命名空间，并与Spring中固定的命名空间<a href="http://www.springframework.org/schema/beans" target="_blank" rel="noopener">http://www.springframework.org/schema/beans</a> 进行比对，如果一致则认为是默认命名空间否则就认为是自定义命名空间解析<br><strong><a id="more"></a></strong></p>
<h1 id="默认命名空间解析"><a href="#默认命名空间解析" class="headerlink" title="默认命名空间解析"></a>默认命名空间解析</h1><p>Spring将默认标签解析分为4种类型，分别为import，alias，bean，和beans标签<br><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">parseDefaultElement</span>(<span class="params">Element ele, BeanDefinitionParserDelegate <span class="keyword">delegate</span></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">delegate</span>.nodeNameEquals(ele, IMPORT_ELEMENT)) &#123;</span><br><span class="line">        <span class="comment">// import标签解析</span></span><br><span class="line">        importBeanDefinitionResource(ele);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">delegate</span>.nodeNameEquals(ele, ALIAS_ELEMENT)) &#123;</span><br><span class="line">        <span class="comment">// alias标签解析</span></span><br><span class="line">        processAliasRegistration(ele);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">delegate</span>.nodeNameEquals(ele, BEAN_ELEMENT)) &#123;</span><br><span class="line">        <span class="comment">// bean标签解析</span></span><br><span class="line">        processBeanDefinition(ele, <span class="keyword">delegate</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">delegate</span>.nodeNameEquals(ele, NESTED_BEANS_ELEMENT)) &#123;</span><br><span class="line">        <span class="comment">// recurse</span></span><br><span class="line">        <span class="comment">// beans标签解析 递归方式</span></span><br><span class="line">        doRegisterBeanDefinitions(ele);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="bean标签解析"><a href="#bean标签解析" class="headerlink" title="bean标签解析"></a>bean标签解析</h2><p>在4种标签中对bean标签的解析最为复杂也最为重要，所以我们从此标签开始深入分析，如果能理解此标签的解析过程，其他标签的解析自然会迎刃而解，在上一篇博客介绍了BeanDefinitionParserDelegate(bean标签解析代理对象)的创建过程，接下来我们将详细介绍使用BeanDefinitionParserDelegate对bean标签的解析过程，bean标签解析的方法的入口为processBeanDefinition<br><figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">protected</span> void processBeanDefinition(Element ele, <span class="keyword">BeanDefinitionParserDelegate </span>delegate) &#123;</span><br><span class="line">    // <span class="number">01</span>.委托<span class="keyword">BeanDefinitionDelegate类的parseBeanDefinitionElement方法进行元素解析</span></span><br><span class="line"><span class="keyword"> </span>   <span class="keyword">BeanDefinitionHolder </span><span class="keyword">bdHolder </span>= delegate.parseBeanDefinitionElement(ele)<span class="comment">;</span></span><br><span class="line">    <span class="meta">if</span> (<span class="keyword">bdHolder </span>!= null) &#123;</span><br><span class="line">        // <span class="number">02</span>.当返回的<span class="keyword">bdHolder不为空的情况下若存在默认标签的子节点下再有自定义属性，还需要再次对自定义标签进行解析</span></span><br><span class="line"><span class="keyword"> </span>       <span class="keyword">bdHolder </span>= delegate.decorateBeanDefinitionIfRequired(ele, <span class="keyword">bdHolder);</span></span><br><span class="line"><span class="keyword"> </span>       try &#123;</span><br><span class="line">            // <span class="number">03</span>.解析完成后需要对解析后的<span class="keyword">bdHolder进行注册，注册操作委托给了BeanDefinitionReaderUtils的registerBeanDefinition方法</span></span><br><span class="line"><span class="keyword"> </span>           <span class="keyword">BeanDefinitionReaderUtils.registerBeanDefinition(bdHolder, </span>getReaderContext().getRegistry())<span class="comment">;</span></span><br><span class="line">        &#125; catch (<span class="keyword">BeanDefinitionStoreException </span>ex) &#123;</span><br><span class="line">            getReaderContext().error(<span class="string">"Failed to register bean definition with name '"</span> + <span class="keyword">bdHolder.getBeanName() </span>+ <span class="string">"'"</span>, ele, ex)<span class="comment">;</span></span><br><span class="line">        &#125;</span><br><span class="line">        // <span class="number">04</span>.最后发出响应事件，通知相关监听器这个<span class="keyword">bean已经被加载</span></span><br><span class="line"><span class="keyword"> </span>       getReaderContext().fireComponentRegistered(new <span class="keyword">BeanComponentDefinition(bdHolder));</span></span><br><span class="line"><span class="keyword"> </span>   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这个方法可以分为四个部分<br><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">01.</span>委托BeanDefinitionDelegate类的parseBeanDefinitionElement方法进行元素解析</span><br><span class="line"><span class="number">02.</span>当返回的bdHolder不为空的情况下若存在默认标签的子节点下再有自定义属性，还需要再次对自定义标签进行解析</span><br><span class="line"><span class="number">03.</span>解析完成后需要对解析后的bdHolder进行注册，注册操作委托给了BeanDefinitionReaderUtils的registerBeanDefinition方法</span><br><span class="line"><span class="number">04.</span>最后发出响应事件，通知相关监听器这个bean已经被加载</span><br></pre></td></tr></table></figure></p>
<h3 id="parseBeanDefinitionElement-Element-ele"><a href="#parseBeanDefinitionElement-Element-ele" class="headerlink" title="parseBeanDefinitionElement(Element ele)"></a>parseBeanDefinitionElement(Element ele)</h3><p>通过该方法返回BeanDefinitionHolder类型的实例bdHolder，经过这个方法后bdHolder实例已经包含我们配置文件中配置的各种属性了，例如class, name, id, alisa等之类的属性<br><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function">BeanDefinitionHolder <span class="title">parseBeanDefinitionElement</span><span class="params">(Element ele)</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">return</span> <span class="title">parseBeanDefinitionElement</span><span class="params">(ele, <span class="keyword">null</span>)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">public</span> <span class="keyword">BeanDefinitionHolder </span>parseBeanDefinitionElement(Element ele, <span class="comment">@Nullable BeanDefinition containingBean) &#123;</span></span><br><span class="line">    // 获取<span class="keyword">Bean标签的ID属性</span></span><br><span class="line"><span class="keyword"> </span>   <span class="keyword">String </span>id = ele.getAttribute(ID_ATTRIBUTE)<span class="comment">;</span></span><br><span class="line">    // 获取<span class="keyword">Bean标签的Name属性</span></span><br><span class="line"><span class="keyword"> </span>   <span class="keyword">String </span>nameAttr = ele.getAttribute(NAME_ATTRIBUTE)<span class="comment">;</span></span><br><span class="line">    List&lt;<span class="keyword">String&gt; </span>aliases = new ArrayList&lt;&gt;()<span class="comment">;</span></span><br><span class="line">    <span class="meta">if</span> (<span class="keyword">StringUtils.hasLength(nameAttr)) </span>&#123;</span><br><span class="line">        // 将name属性的值通过,<span class="comment">; 进行分割 转为字符串数字(即在配置文件中如配置多个name 在此做处理)</span></span><br><span class="line">        <span class="keyword">String[] </span>nameArr = <span class="keyword">StringUtils.tokenizeToStringArray(nameAttr, </span><span class="keyword">MULTI_VALUE_ATTRIBUTE_DELIMITERS);</span></span><br><span class="line"><span class="keyword"> </span>       aliases.<span class="keyword">addAll(Arrays.asList(nameArr));</span></span><br><span class="line"><span class="keyword"> </span>   &#125;</span><br><span class="line">    <span class="keyword">String </span><span class="keyword">beanName </span>= id<span class="comment">;</span></span><br><span class="line">    // 如果ID为空 使用配置的第一个name属性作为ID</span><br><span class="line">    <span class="meta">if</span> (!<span class="keyword">StringUtils.hasText(beanName) </span>&amp;&amp; !aliases.isEmpty()) &#123;</span><br><span class="line">        <span class="keyword">beanName </span>= aliases.remove(<span class="number">0</span>)<span class="comment">;</span></span><br><span class="line">        <span class="meta">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">            logger.debug(<span class="string">"No XML 'id' specified - using '"</span> + <span class="keyword">beanName </span>+ <span class="string">"' as bean name and "</span> + aliases + <span class="string">" as aliases"</span>)<span class="comment">;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">if</span> (containingBean == null) &#123;</span><br><span class="line">        // 校验<span class="keyword">beanName和aliases的唯一性</span></span><br><span class="line"><span class="keyword"> </span>       // 内部核心为使用usedNames集合保存所有已经使用了的<span class="keyword">beanName和alisa</span></span><br><span class="line"><span class="keyword"> </span>       checkNameUniqueness(<span class="keyword">beanName, </span>aliases, ele)<span class="comment">;</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // 进一步解析其他所有属性到GenericBeanDefinition对象中</span><br><span class="line">    AbstractBeanDefinition <span class="keyword">beanDefinition </span>= parseBeanDefinitionElement(ele, <span class="keyword">beanName, </span>containingBean)<span class="comment">;</span></span><br><span class="line">    <span class="meta">if</span> (<span class="keyword">beanDefinition </span>!= null) &#123;</span><br><span class="line">        // 如果<span class="keyword">bean没有指定beanName </span>那么使用默认规则为此<span class="keyword">Bean生成beanName</span></span><br><span class="line"><span class="keyword"> </span>       <span class="meta">if</span> (!<span class="keyword">StringUtils.hasText(beanName)) </span>&#123;</span><br><span class="line">            try &#123;</span><br><span class="line">                <span class="meta">if</span> (containingBean != null) &#123;</span><br><span class="line">                    <span class="keyword">beanName </span>= <span class="keyword">BeanDefinitionReaderUtils.generateBeanName(beanDefinition, </span>this.readerContext.getRegistry(), true)<span class="comment">;</span></span><br><span class="line">                &#125; <span class="meta">else</span> &#123;</span><br><span class="line">                    <span class="keyword">beanName </span>= this.readerContext.generateBeanName(<span class="keyword">beanDefinition);</span></span><br><span class="line"><span class="keyword"> </span>                   // Register an <span class="meta">alias</span> for the plain <span class="keyword">bean </span>class name, <span class="meta">if</span> still possible,</span><br><span class="line">                    // <span class="meta">if</span> the generator returned the class name plus a suffix.</span><br><span class="line">                    // This is expected for Spring <span class="number">1</span>.<span class="number">2</span>/<span class="number">2</span>.<span class="number">0</span> <span class="keyword">backwards </span>compatibility.</span><br><span class="line">                    <span class="keyword">String </span><span class="keyword">beanClassName </span>= <span class="keyword">beanDefinition.getBeanClassName();</span></span><br><span class="line"><span class="keyword"> </span>                   <span class="meta">if</span> (<span class="keyword">beanClassName </span>!= null &amp;&amp; <span class="keyword">beanName.startsWith(beanClassName) </span>&amp;&amp; <span class="keyword">beanName.length() </span>&gt; <span class="keyword">beanClassName.length() </span>&amp;&amp; !this.readerContext.getRegistry().<span class="keyword">isBeanNameInUse(beanClassName)) </span>&#123;</span><br><span class="line">                        aliases.<span class="keyword">add(beanClassName);</span></span><br><span class="line"><span class="keyword"> </span>                   &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="meta">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">                    logger.debug(<span class="string">"Neither XML 'id' nor 'name' specified - "</span> + <span class="string">"using generated bean name ["</span> + <span class="keyword">beanName </span>+ <span class="string">"]"</span>)<span class="comment">;</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125; catch (Exception ex) &#123;</span><br><span class="line">                error(ex.getMessage(), ele)<span class="comment">;</span></span><br><span class="line">                return null<span class="comment">;</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">String[] </span>aliasesArray = <span class="keyword">StringUtils.toStringArray(aliases);</span></span><br><span class="line"><span class="keyword"> </span>       // 将信息封装到<span class="keyword">BeanDefinitionHolder对象中</span></span><br><span class="line"><span class="keyword"> </span>       return new <span class="keyword">BeanDefinitionHolder(beanDefinition, </span><span class="keyword">beanName, </span>aliasesArray)<span class="comment">;</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return null<span class="comment">;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>该方法主要完成三个功能，第一部分是处理id，alias等标识相关的东西，第二部分是核心的标签解析，标签解析功能主要是在重载函数parseBeanDefinitionElement(ele, beanName, containingBean)方法中完成，第三部分是对beanName的处理，接下来我们重点分析第二部分内容</p>
<h4 id="parseBeanDefinitionElement-Element-ele-String-beanName-Nullable-BeanDefinition-containingBean"><a href="#parseBeanDefinitionElement-Element-ele-String-beanName-Nullable-BeanDefinition-containingBean" class="headerlink" title="parseBeanDefinitionElement(Element ele, String beanName, @Nullable BeanDefinition containingBean)"></a>parseBeanDefinitionElement(Element ele, String beanName, @Nullable BeanDefinition containingBean)</h4><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> AbstractBeanDefinition parseBeanDefinitionElement(Element ele, String beanName, <span class="meta">@Nullable</span> BeanDefinition containingBean) &#123;</span><br><span class="line">    <span class="keyword">this</span>.parseState.push(new BeanEntry(beanName));</span><br><span class="line">    <span class="comment">// 获取Bean标签的class属性</span></span><br><span class="line">    String className = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">if</span> (ele.hasAttribute(CLASS_ATTRIBUTE)) &#123;</span><br><span class="line">        className = ele.getAttribute(CLASS_ATTRIBUTE).trim();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 获取Bean标签的parent属性</span></span><br><span class="line">    String parent = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">if</span> (ele.hasAttribute(PARENT_ATTRIBUTE)) &#123;</span><br><span class="line">        parent = ele.getAttribute(PARENT_ATTRIBUTE);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 创建用于承载属性的AbstractBeanDefinition</span></span><br><span class="line">        AbstractBeanDefinition bd = createBeanDefinition(className, parent);</span><br><span class="line">        <span class="comment">// 获取bean标签各种属性</span></span><br><span class="line">        parseBeanDefinitionAttributes(ele, beanName, containingBean, bd);</span><br><span class="line">        <span class="comment">// 解析description标签</span></span><br><span class="line">        bd.setDescription(DomUtils.getChildElementValueByTagName(ele, DESCRIPTION_ELEMENT));</span><br><span class="line">        <span class="comment">// 解析meta标签</span></span><br><span class="line">        parseMetaElements(ele, bd);</span><br><span class="line">        <span class="comment">// 解析lookup-method标签</span></span><br><span class="line">        parseLookupOverrideSubElements(ele, bd.getMethodOverrides());</span><br><span class="line">        <span class="comment">// 解析replaced-method标签</span></span><br><span class="line">        parseReplacedMethodSubElements(ele, bd.getMethodOverrides());</span><br><span class="line">        <span class="comment">// 解析constructor-arg标签</span></span><br><span class="line">        parseConstructorArgElements(ele, bd);</span><br><span class="line">        <span class="comment">// 解析property标签</span></span><br><span class="line">        parsePropertyElements(ele, bd);</span><br><span class="line">        <span class="comment">// 解析qualifier标签</span></span><br><span class="line">        parseQualifierElements(ele, bd);</span><br><span class="line"></span><br><span class="line">        bd.setResource(<span class="keyword">this</span>.readerContext.getResource());</span><br><span class="line">        bd.setSource(extractSource(ele));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> bd;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (ClassNotFoundException ex) &#123;</span><br><span class="line">        error(<span class="string">"Bean class ["</span> + className + <span class="string">"] not found"</span>, ele, ex);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (NoClassDefFoundError err) &#123;</span><br><span class="line">        error(<span class="string">"Class that bean class ["</span> + className + <span class="string">"] depends on not found"</span>, ele, err);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable ex) &#123;</span><br><span class="line">        error(<span class="string">"Unexpected failure during bean definition parsing"</span>, ele, ex);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">this</span>.parseState.pop();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>createBeanDefinition(@Nullable String className, @Nullable String parentName) 创建用于承载属性的GenericBeanDefinition</strong><br><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">protected</span> <span class="selector-tag">AbstractBeanDefinition</span> <span class="selector-tag">createBeanDefinition</span>(<span class="variable">@Nullable</span> String className, <span class="variable">@Nullable</span> String parentName) <span class="selector-tag">throws</span> <span class="selector-tag">ClassNotFoundException</span> &#123;</span><br><span class="line">    <span class="selector-tag">return</span> <span class="selector-tag">BeanDefinitionReaderUtils</span><span class="selector-class">.createBeanDefinition</span>(parentName, className, this.readerContext.getBeanClassLoader());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> AbstractBeanDefinition createBeanDefinition(<span class="meta">@Nullable</span> <span class="built_in">String</span> parentName, <span class="meta">@Nullable</span> <span class="built_in">String</span> className, <span class="meta">@Nullable</span> ClassLoader classLoader) throws ClassNotFoundException &#123;</span><br><span class="line">    GenericBeanDefinition bd = <span class="keyword">new</span> GenericBeanDefinition();</span><br><span class="line">    <span class="comment">// parentName可能为空</span></span><br><span class="line">    bd.setParentName(parentName);</span><br><span class="line">    <span class="keyword">if</span> (className != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// 如果classLoader不为空 </span></span><br><span class="line">        <span class="comment">// 则使用传入的classLoader同一虚拟机加载类对象 否则只记录classLoader</span></span><br><span class="line">        <span class="keyword">if</span> (classLoader != <span class="literal">null</span>) &#123;</span><br><span class="line">            bd.setBeanClass(ClassUtils.forName(className, classLoader));</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            bd.setBeanClassName(className);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> bd;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>parseBeanDefinitionAttributes(Element ele, String beanName, @Nullable BeanDefinition containingBean, AbstractBeanDefinition bd) 解析Bean各种属性到GenericBeanDefinition对象中</strong><br><figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">public</span> AbstractBeanDefinition parseBeanDefinitionAttributes(Element ele, <span class="keyword">String </span><span class="keyword">beanName, </span><span class="comment">@Nullable BeanDefinition containingBean, AbstractBeanDefinition bd) &#123;</span></span><br><span class="line">    <span class="meta">if</span> (ele.hasAttribute(SINGLETON_ATTRIBUTE)) &#123;</span><br><span class="line">        // 如果配置了singleton属性抛出异常 该属性已经废弃</span><br><span class="line">        error(<span class="string">"Old 1.x 'singleton' attribute in use - upgrade to 'scope' declaration"</span>, ele)<span class="comment">;</span></span><br><span class="line">    &#125; <span class="meta">else</span> <span class="meta">if</span> (ele.hasAttribute(SCOPE_ATTRIBUTE)) &#123;</span><br><span class="line">        // 获取<span class="keyword">Bean标签的scope属性</span></span><br><span class="line"><span class="keyword"> </span>       <span class="keyword">bd.setScope(ele.getAttribute(SCOPE_ATTRIBUTE));</span></span><br><span class="line"><span class="keyword"> </span>   &#125; <span class="meta">else</span> <span class="meta">if</span> (containingBean != null) &#123;</span><br><span class="line">        // 如果有内部类 使用内部类的scope属性</span><br><span class="line">        <span class="keyword">bd.setScope(containingBean.getScope());</span></span><br><span class="line"><span class="keyword"> </span>   &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">if</span> (ele.hasAttribute(ABSTRACT_ATTRIBUTE)) &#123;</span><br><span class="line">        // 获取<span class="keyword">Bean标签的abstract属性</span></span><br><span class="line"><span class="keyword"> </span>       <span class="keyword">bd.setAbstract(TRUE_VALUE.equals(ele.getAttribute(ABSTRACT_ATTRIBUTE)));</span></span><br><span class="line"><span class="keyword"> </span>   &#125;</span><br><span class="line"></span><br><span class="line">    // 获取<span class="keyword">Bean标签的lazy-init属性</span></span><br><span class="line"><span class="keyword"> </span>   <span class="keyword">String </span>lazyInit = ele.getAttribute(LAZY_INIT_ATTRIBUTE)<span class="comment">;</span></span><br><span class="line">    <span class="meta">if</span> (DEFAULT_VALUE.equals(lazyInit)) &#123;</span><br><span class="line">        lazyInit = this.defaults.getLazyInit()<span class="comment">;</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">bd.setLazyInit(TRUE_VALUE.equals(lazyInit));</span></span><br><span class="line"><span class="keyword"></span></span><br><span class="line"><span class="keyword"> </span>   // 获取<span class="keyword">Bean标签的autowire属性</span></span><br><span class="line"><span class="keyword"> </span>   <span class="keyword">String </span>autowire = ele.getAttribute(AUTOWIRE_ATTRIBUTE)<span class="comment">;</span></span><br><span class="line">    <span class="keyword">bd.setAutowireMode(getAutowireMode(autowire));</span></span><br><span class="line"><span class="keyword"></span></span><br><span class="line"><span class="keyword"> </span>   // 获取<span class="keyword">Bean标签的depends-on属性</span></span><br><span class="line"><span class="keyword"> </span>   <span class="meta">if</span> (ele.hasAttribute(DEPENDS_ON_ATTRIBUTE)) &#123;</span><br><span class="line">        <span class="keyword">String </span>dependsOn = ele.getAttribute(DEPENDS_ON_ATTRIBUTE)<span class="comment">;</span></span><br><span class="line">        <span class="keyword">bd.setDependsOn(StringUtils.tokenizeToStringArray(dependsOn, </span><span class="keyword">MULTI_VALUE_ATTRIBUTE_DELIMITERS));</span></span><br><span class="line"><span class="keyword"> </span>   &#125;</span><br><span class="line"></span><br><span class="line">    // 获取<span class="keyword">Bean标签的autowire-candidate属性</span></span><br><span class="line"><span class="keyword"> </span>   <span class="keyword">String </span>autowireCandidate = ele.getAttribute(AUTOWIRE_CANDIDATE_ATTRIBUTE)<span class="comment">;</span></span><br><span class="line">    <span class="meta">if</span> (<span class="string">""</span>.equals(autowireCandidate) <span class="title">||</span> DEFAULT_VALUE.equals(autowireCandidate)) &#123;</span><br><span class="line">        <span class="keyword">String </span>candidatePattern = this.defaults.getAutowireCandidates()<span class="comment">;</span></span><br><span class="line">        <span class="meta">if</span> (candidatePattern != null) &#123;</span><br><span class="line">            <span class="keyword">String[] </span>patterns = <span class="keyword">StringUtils.commaDelimitedListToStringArray(candidatePattern);</span></span><br><span class="line"><span class="keyword"> </span>           <span class="keyword">bd.setAutowireCandidate(PatternMatchUtils.simpleMatch(patterns, </span><span class="keyword">beanName));</span></span><br><span class="line"><span class="keyword"> </span>       &#125;</span><br><span class="line">    &#125; <span class="meta">else</span> &#123;</span><br><span class="line">        <span class="keyword">bd.setAutowireCandidate(TRUE_VALUE.equals(autowireCandidate));</span></span><br><span class="line"><span class="keyword"> </span>   &#125;</span><br><span class="line"></span><br><span class="line">    // 获取<span class="keyword">Bean标签的primary属性</span></span><br><span class="line"><span class="keyword"> </span>   <span class="meta">if</span> (ele.hasAttribute(PRIMARY_ATTRIBUTE)) &#123;</span><br><span class="line">        <span class="keyword">bd.setPrimary(TRUE_VALUE.equals(ele.getAttribute(PRIMARY_ATTRIBUTE)));</span></span><br><span class="line"><span class="keyword"> </span>   &#125;</span><br><span class="line"></span><br><span class="line">    // 获取<span class="keyword">Bean标签的init-method属性</span></span><br><span class="line"><span class="keyword"> </span>   <span class="meta">if</span> (ele.hasAttribute(INIT_METHOD_ATTRIBUTE)) &#123;</span><br><span class="line">        <span class="keyword">String </span>initMethodName = ele.getAttribute(INIT_METHOD_ATTRIBUTE)<span class="comment">;</span></span><br><span class="line">        <span class="keyword">bd.setInitMethodName(initMethodName);</span></span><br><span class="line"><span class="keyword"> </span>   &#125; <span class="meta">else</span> <span class="meta">if</span> (this.defaults.getInitMethod() != null) &#123;</span><br><span class="line">        <span class="keyword">bd.setInitMethodName(this.defaults.getInitMethod());</span></span><br><span class="line"><span class="keyword"> </span>       <span class="keyword">bd.setEnforceInitMethod(false);</span></span><br><span class="line"><span class="keyword"> </span>   &#125;</span><br><span class="line"></span><br><span class="line">    // 获取<span class="keyword">Bean标签的destroy-method属性</span></span><br><span class="line"><span class="keyword"> </span>   <span class="meta">if</span> (ele.hasAttribute(DESTROY_METHOD_ATTRIBUTE)) &#123;</span><br><span class="line">        <span class="keyword">String </span>destroyMethodName = ele.getAttribute(DESTROY_METHOD_ATTRIBUTE)<span class="comment">;</span></span><br><span class="line">        <span class="keyword">bd.setDestroyMethodName(destroyMethodName);</span></span><br><span class="line"><span class="keyword"> </span>   &#125; <span class="meta">else</span> <span class="meta">if</span> (this.defaults.getDestroyMethod() != null) &#123;</span><br><span class="line">        <span class="keyword">bd.setDestroyMethodName(this.defaults.getDestroyMethod());</span></span><br><span class="line"><span class="keyword"> </span>       <span class="keyword">bd.setEnforceDestroyMethod(false);</span></span><br><span class="line"><span class="keyword"> </span>   &#125;</span><br><span class="line"></span><br><span class="line">    // 获取<span class="keyword">Bean标签的factory-method属性</span></span><br><span class="line"><span class="keyword"> </span>   <span class="meta">if</span> (ele.hasAttribute(FACTORY_METHOD_ATTRIBUTE)) &#123;</span><br><span class="line">        <span class="keyword">bd.setFactoryMethodName(ele.getAttribute(FACTORY_METHOD_ATTRIBUTE));</span></span><br><span class="line"><span class="keyword"> </span>   &#125;</span><br><span class="line"></span><br><span class="line">    // 获取<span class="keyword">Bean标签的factory-bean属性</span></span><br><span class="line"><span class="keyword"> </span>   <span class="meta">if</span> (ele.hasAttribute(FACTORY_BEAN_ATTRIBUTE)) &#123;</span><br><span class="line">        <span class="keyword">bd.setFactoryBeanName(ele.getAttribute(FACTORY_BEAN_ATTRIBUTE));</span></span><br><span class="line"><span class="keyword"> </span>   &#125;</span><br><span class="line"></span><br><span class="line">    return <span class="keyword">bd;</span></span><br><span class="line"><span class="keyword">&#125;</span></span><br></pre></td></tr></table></figure></p>
<p><strong>parseMetaElements(Element ele, BeanMetadataAttributeAccessor attributeAccessor) 解析meta标签到GenericBeanDefinition中</strong><br><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">public <span class="keyword">void</span> parseMetaElements(<span class="built_in">Element</span> ele, BeanMetadataAttributeAccessor attributeAccessor) &#123;</span><br><span class="line">    <span class="comment">// 获取当前节点下的所有子元素</span></span><br><span class="line">    NodeList nl = ele.getChildNodes();</span><br><span class="line">    <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; nl.getLength(); i++) &#123;</span><br><span class="line">        Node node = nl.item(i);</span><br><span class="line">        <span class="keyword">if</span> (isCandidateElement(node) &amp;&amp; nodeNameEquals(node, META_ELEMENT)) &#123;</span><br><span class="line">            <span class="comment">// 解析META标签</span></span><br><span class="line">            <span class="built_in">Element</span> metaElement = (<span class="built_in">Element</span>) node;</span><br><span class="line">            <span class="built_in">String</span> key = metaElement.getAttribute(KEY_ATTRIBUTE);</span><br><span class="line">            <span class="built_in">String</span> value = metaElement.getAttribute(VALUE_ATTRIBUTE);</span><br><span class="line">            BeanMetadataAttribute attribute = <span class="keyword">new</span> BeanMetadataAttribute(key, value);</span><br><span class="line">            attribute.setSource(extractSource(metaElement));</span><br><span class="line">            attributeAccessor.addMetadataAttribute(attribute);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><strong>parseLookupOverrideSubElements(Element beanEle, MethodOverrides overrides) 解析lookup-method标签到GenericBeanDefinition中</strong><br><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">parseLookupOverrideSubElements</span>(<span class="params">Element beanEle, MethodOverrides overrides</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// 获取当前节点下的所有子元素</span></span><br><span class="line">    NodeList nl = beanEle.getChildNodes();</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; nl.getLength(); i++) &#123;</span><br><span class="line">        Node node = nl.item(i);</span><br><span class="line">        <span class="keyword">if</span> (isCandidateElement(node) &amp;&amp; nodeNameEquals(node, LOOKUP_METHOD_ELEMENT)) &#123;</span><br><span class="line">            <span class="comment">// 解析lookup-method标签</span></span><br><span class="line">            Element ele = (Element) node;</span><br><span class="line">            String methodName = ele.getAttribute(NAME_ATTRIBUTE);</span><br><span class="line">            String beanRef = ele.getAttribute(BEAN_ELEMENT);</span><br><span class="line">            LookupOverride <span class="keyword">override</span> = <span class="keyword">new</span> LookupOverride(methodName, beanRef);</span><br><span class="line">            <span class="keyword">override</span>.setSource(extractSource(ele));</span><br><span class="line">            overrides.addOverride(<span class="keyword">override</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>lookup-method通常称为获取器注入，它是一种特殊的方法注入，它是把一个方法声明为返回某种类型的bean，而实际要返回的bean是在配置文件里面配置的，可用在设计可插拔的功能上，降低程序耦合度，下面介绍一个lookup-method的demo</p>
<p>新建歌手方法抽象类Singer，声明抽象方法sing<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.springframework.roberto._05_lookup_method;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Singer</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">sing</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>创建歌手陈奕迅继承该抽象类，实现sing方法<br><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.springframework.roberto._05_lookup_method;</span><br><span class="line"></span><br><span class="line">public <span class="class"><span class="keyword">class</span> <span class="title">EasonChen</span> <span class="keyword">extends</span> <span class="title">Singer</span></span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    public void sing() &#123;</span><br><span class="line">        <span class="type">System</span>.out.println(<span class="string">"十年"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>创建演唱会类，选择哪个歌手开演唱会<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.springframework.roberto._05_lookup_method;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">VocalConcert</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sing</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.getSinger().sing();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> Singer <span class="title">getSinger</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>配置文件声明如下<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="php"><span class="meta">&lt;?</span>xml version=<span class="string">"1.0"</span> encoding=<span class="string">"UTF-8"</span><span class="meta">?&gt;</span></span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">"http://www.springframework.org/schema/beans"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://www.springframework.org/schema/beans    http://www.springframework.org/schema/beans/spring-beans.xsd"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">beans</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"vocalConcert"</span> <span class="attr">class</span>=<span class="string">"org.springframework.roberto._05_lookup_method.VocalConcert"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">lookup-method</span> <span class="attr">name</span>=<span class="string">"getSinger"</span> <span class="attr">bean</span>=<span class="string">"easonChen"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"easonChen"</span> <span class="attr">class</span>=<span class="string">"org.springframework.roberto._05_lookup_method.EasonChen"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>新建测试类，测试演唱会功能<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.springframework.roberto;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.junit.Test;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.BeanFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.xml.XmlBeanFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.core.io.ClassPathResource;</span><br><span class="line"><span class="keyword">import</span> org.springframework.roberto._05_lookup_method.VocalConcert;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SuppressWarnings</span>(<span class="string">"all"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">_05_LookupMethodTest</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testLookupMethod</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        BeanFactory beanFactory = <span class="keyword">new</span> XmlBeanFactory(<span class="keyword">new</span> ClassPathResource(<span class="string">"05.lookup_method.xml"</span>));</span><br><span class="line">        VocalConcert vocalConcert = (VocalConcert) beanFactory.getBean(<span class="string">"vocalConcert"</span>);</span><br><span class="line">        vocalConcert.sing();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>测试结果输出十年，这里只是调用了一个没有实现的抽象方法就完成了执行，其原理在于将EasonChen作为getSinger方法的返回值，这么做有利于程序的拓展。比如下次换张学友来开演唱会的时候，我们只需要把陈奕迅换成张学友即可，不用改动VocalConcert的任何代码</p>
<p><strong>parseReplacedMethodSubElements(Element beanEle, MethodOverrides overrides) 解析replaced-method标签到GenericBeanDefinition中</strong><br><figure class="highlight processing"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> parseReplacedMethodSubElements(Element beanEle, MethodOverrides overrides) &#123;</span><br><span class="line">    <span class="comment">// 获取当前节点下的所有子元素</span></span><br><span class="line">    NodeList nl = beanEle.getChildNodes();</span><br><span class="line">    <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; nl.getLength(); i++) &#123;</span><br><span class="line">        Node node = nl.item(i);</span><br><span class="line">        <span class="keyword">if</span> (isCandidateElement(node) &amp;&amp; nodeNameEquals(node, REPLACED_METHOD_ELEMENT)) &#123;</span><br><span class="line">            <span class="comment">// 解析replaced-method标签</span></span><br><span class="line">            Element replacedMethodEle = (Element) node;</span><br><span class="line">            <span class="comment">// 提取要替换的旧方法</span></span><br><span class="line">            <span class="keyword">String</span> name = replacedMethodEle.getAttribute(NAME_ATTRIBUTE);</span><br><span class="line">            <span class="comment">// 提取对应新的替换方法</span></span><br><span class="line">            <span class="keyword">String</span> callback = replacedMethodEle.getAttribute(REPLACER_ATTRIBUTE);</span><br><span class="line">            ReplaceOverride replaceOverride = <span class="keyword">new</span> ReplaceOverride(name, callback);</span><br><span class="line">            <span class="comment">// Look for arg-type match elements.</span></span><br><span class="line">            <span class="comment">// 记录参数</span></span><br><span class="line">            List&lt;Element&gt; argTypeEles = DomUtils.getChildElementsByTagName(replacedMethodEle, ARG_TYPE_ELEMENT);</span><br><span class="line">            <span class="keyword">for</span> (Element argTypeEle : argTypeEles) &#123;</span><br><span class="line">                <span class="keyword">String</span> <span class="built_in">match</span> = argTypeEle.getAttribute(ARG_TYPE_MATCH_ATTRIBUTE);</span><br><span class="line">                <span class="built_in">match</span> = (StringUtils.hasText(<span class="built_in">match</span>) ? <span class="built_in">match</span> : DomUtils.getTextValue(argTypeEle));</span><br><span class="line">                <span class="keyword">if</span> (StringUtils.hasText(<span class="built_in">match</span>)) &#123;</span><br><span class="line">                    replaceOverride.addTypeIdentifier(<span class="built_in">match</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            replaceOverride.setSource(extractSource(replacedMethodEle));</span><br><span class="line">            overrides.addOverride(replaceOverride);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>replaced-method可以在运行时用新的方法替换掉旧的方法，如上面的例子假设现在举办方要陈奕迅演唱粤语版的十年(明年今日)，如果我们直接去改EasonChen中的方法其实是不合理的，我们新建一个类叫EasonChenBack实现Spring的MethodReplacer方法，并修改配置即可替换掉原来的方法<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.springframework.roberto._06_replace_method;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.support.MethodReplacer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EasonChenBack</span> <span class="keyword">implements</span> <span class="title">MethodReplacer</span></span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">reimplement</span><span class="params">(Object obj, Method method, Object[] args)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"明年今日"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="php"><span class="meta">&lt;?</span>xml version=<span class="string">"1.0"</span> encoding=<span class="string">"UTF-8"</span><span class="meta">?&gt;</span></span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">"http://www.springframework.org/schema/beans"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://www.springframework.org/schema/beans    http://www.springframework.org/schema/beans/spring-beans.xsd"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">beans</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"vocalConcert"</span> <span class="attr">class</span>=<span class="string">"org.springframework.roberto._05_lookup_method.VocalConcert"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">lookup-method</span> <span class="attr">name</span>=<span class="string">"getSinger"</span> <span class="attr">bean</span>=<span class="string">"easonChen"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"easonChen"</span> <span class="attr">class</span>=<span class="string">"org.springframework.roberto._05_lookup_method.EasonChen"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">replaced-method</span> <span class="attr">name</span>=<span class="string">"sing"</span> <span class="attr">replacer</span>=<span class="string">"easonChenBack"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"easonChenBack"</span> <span class="attr">class</span>=<span class="string">"org.springframework.roberto._06_replace_method.EasonChenBack"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>运行结果输出十年今日，也就是原来EasonChen中的sing方法已经被替换掉了</p>
<p><strong>parseConstructorArgElements(Element beanEle, BeanDefinition bd) 解析constructor-arg标签到GenericBeanDefinition中</strong><br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">parseConstructorArgElements</span><span class="params">(Element beanEle, BeanDefinition bd)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 获取当前节点下的所有子元素</span></span><br><span class="line">    NodeList nl = beanEle.getChildNodes();</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; nl.getLength(); i++) &#123;</span><br><span class="line">        Node node = nl.item(i);</span><br><span class="line">        <span class="keyword">if</span> (isCandidateElement(node) &amp;&amp; nodeNameEquals(node, CONSTRUCTOR_ARG_ELEMENT)) &#123;</span><br><span class="line">            <span class="comment">// 解析constructor-arg标签</span></span><br><span class="line">            parseConstructorArgElement((Element) node, bd);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<figure class="highlight axapta"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> parseConstructorArgElement(Element ele, BeanDefinition bd) &#123;</span><br><span class="line">    <span class="comment">// 获取index属性</span></span><br><span class="line">    String indexAttr = ele.getAttribute(INDEX_ATTRIBUTE);</span><br><span class="line">    <span class="comment">// 获取type属性</span></span><br><span class="line">    String typeAttr = ele.getAttribute(TYPE_ATTRIBUTE);</span><br><span class="line">    <span class="comment">// 获取name属性</span></span><br><span class="line">    String nameAttr = ele.getAttribute(NAME_ATTRIBUTE);</span><br><span class="line">    <span class="keyword">if</span> (StringUtils.hasLength(indexAttr)) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">int</span> <span class="keyword">index</span> = Integer.parseInt(indexAttr);</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">index</span> &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                error(<span class="string">"'index' cannot be lower than 0"</span>, ele);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="keyword">this</span>.parseState.push(<span class="keyword">new</span> ConstructorArgumentEntry(<span class="keyword">index</span>));</span><br><span class="line">                    <span class="comment">// 解析ele对应的属性元素</span></span><br><span class="line">                    Object value = parsePropertyValue(ele, bd, <span class="keyword">null</span>);</span><br><span class="line">                    ConstructorArgumentValues.ValueHolder valueHolder = <span class="keyword">new</span> ConstructorArgumentValues.ValueHolder(value);</span><br><span class="line">                    <span class="keyword">if</span> (StringUtils.hasLength(typeAttr)) &#123;</span><br><span class="line">                        valueHolder.setType(typeAttr);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span> (StringUtils.hasLength(nameAttr)) &#123;</span><br><span class="line">                        valueHolder.setName(nameAttr);</span><br><span class="line">                    &#125;</span><br><span class="line">                    valueHolder.setSource(extractSource(ele));</span><br><span class="line">                    <span class="comment">// 不允许重复指定相同的参数</span></span><br><span class="line">                    <span class="keyword">if</span> (bd.getConstructorArgumentValues().hasIndexedArgumentValue(<span class="keyword">index</span>)) &#123;</span><br><span class="line">                        error(<span class="string">"Ambiguous constructor-arg entries for index "</span> + <span class="keyword">index</span>, ele);</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        bd.getConstructorArgumentValues().addIndexedArgumentValue(<span class="keyword">index</span>, valueHolder);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                    <span class="keyword">this</span>.parseState.pop();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NumberFormatException ex) &#123;</span><br><span class="line">            error(<span class="string">"Attribute 'index' of tag 'constructor-arg' must be an integer"</span>, ele);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 没有index属性解析</span></span><br><span class="line">            <span class="keyword">this</span>.parseState.push(<span class="keyword">new</span> ConstructorArgumentEntry());</span><br><span class="line">            <span class="comment">// 解析ele对应的属性元素</span></span><br><span class="line">            Object value = parsePropertyValue(ele, bd, <span class="keyword">null</span>);</span><br><span class="line">            ConstructorArgumentValues.ValueHolder valueHolder = <span class="keyword">new</span> ConstructorArgumentValues.ValueHolder(value);</span><br><span class="line">            <span class="keyword">if</span> (StringUtils.hasLength(typeAttr)) &#123;</span><br><span class="line">                valueHolder.setType(typeAttr);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (StringUtils.hasLength(nameAttr)) &#123;</span><br><span class="line">                valueHolder.setName(nameAttr);</span><br><span class="line">            &#125;</span><br><span class="line">            valueHolder.setSource(extractSource(ele));</span><br><span class="line">            bd.getConstructorArgumentValues().addGenericArgumentValue(valueHolder);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">this</span>.parseState.pop();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>parsePropertyValue(Element ele, BeanDefinition bd, @Nullable String propertyName) 该方法用于获取一个属性元素的值，可以是ref value或者list等，如果propertyName设置为null即为构造函数获取值方式</strong><br><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function">Object <span class="title">parsePropertyValue</span><span class="params">(Element ele, BeanDefinition bd, @Nullable String propertyName)</span> </span>&#123;</span><br><span class="line">    String elementName = (propertyName != <span class="keyword">null</span>) ? <span class="string">"&lt;property&gt; element for property '"</span> + propertyName + <span class="string">"'"</span> :  <span class="string">"&lt;constructor-arg&gt; element"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 一个属性只能对应一种子标签 ref value或者list等</span></span><br><span class="line">    NodeList nl = ele.getChildNodes();</span><br><span class="line">    Element subElement = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; nl.getLength(); i++) &#123;</span><br><span class="line">        Node node = nl.item(i);</span><br><span class="line">        <span class="comment">// 对description或者meta不处理</span></span><br><span class="line">        <span class="keyword">if</span> (node <span class="keyword">instanceof</span> Element &amp;&amp; !nodeNameEquals(node, DESCRIPTION_ELEMENT) &amp;&amp; !nodeNameEquals(node, META_ELEMENT)) &#123;</span><br><span class="line">            <span class="comment">// Child element is what we're looking for.</span></span><br><span class="line">            <span class="keyword">if</span> (subElement != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">error</span>(elementName + <span class="string">" must not contain more than one sub-element"</span>, ele);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                subElement = (Element) node;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取ref属性</span></span><br><span class="line">    <span class="keyword">boolean</span> hasRefAttribute = ele.hasAttribute(REF_ATTRIBUTE);</span><br><span class="line">    <span class="comment">// 获取value属性</span></span><br><span class="line">    <span class="keyword">boolean</span> hasValueAttribute = ele.hasAttribute(VALUE_ATTRIBUTE);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1.同时既有ref属性又有value属性 则报错</span></span><br><span class="line">    <span class="comment">// 2.存在ref属性或者value属性且又有子元素 则报错</span></span><br><span class="line">    <span class="keyword">if</span> ((hasRefAttribute &amp;&amp; hasValueAttribute) || ((hasRefAttribute || hasValueAttribute) &amp;&amp; subElement != <span class="keyword">null</span>)) &#123;</span><br><span class="line">        <span class="keyword">error</span>(elementName + <span class="string">" is only allowed to contain either 'ref' attribute OR 'value' attribute OR sub-element"</span>, ele);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (hasRefAttribute) &#123;</span><br><span class="line">        <span class="comment">// 对ref属性处理</span></span><br><span class="line">        String refName = ele.getAttribute(REF_ATTRIBUTE);</span><br><span class="line">        <span class="keyword">if</span> (!StringUtils.hasText(refName)) &#123;</span><br><span class="line">            <span class="keyword">error</span>(elementName + <span class="string">" contains empty 'ref' attribute"</span>, ele);</span><br><span class="line">        &#125;</span><br><span class="line">        RuntimeBeanReference ref = <span class="keyword">new</span> RuntimeBeanReference(refName);</span><br><span class="line">        ref.setSource(extractSource(ele));</span><br><span class="line">        <span class="keyword">return</span> ref;</span><br><span class="line">    &#125; <span class="function"><span class="keyword">else</span> <span class="title">if</span> <span class="params">(hasValueAttribute)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 对value属性处理</span></span><br><span class="line">        TypedStringValue valueHolder = <span class="keyword">new</span> TypedStringValue(ele.getAttribute(VALUE_ATTRIBUTE));</span><br><span class="line">        valueHolder.setSource(extractSource(ele));</span><br><span class="line">        <span class="keyword">return</span> valueHolder;</span><br><span class="line">    &#125; <span class="function"><span class="keyword">else</span> <span class="title">if</span> <span class="params">(subElement != <span class="keyword">null</span>)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 子元素解析</span></span><br><span class="line">        <span class="function"><span class="keyword">return</span> <span class="title">parsePropertySubElement</span><span class="params">(subElement, bd)</span></span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 既没有ref也没有value也没有子元素 报错</span></span><br><span class="line">        <span class="keyword">error</span>(elementName + <span class="string">" must specify a ref or value"</span>, ele);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这里主要流程可以分为五个部分<br><figure class="highlight ocaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span>解析出子元素<span class="built_in">ref</span>，<span class="keyword">value</span>，<span class="built_in">list</span>，map等</span><br><span class="line"><span class="number">2.</span>校验是否同时拥有<span class="built_in">ref</span>属性和<span class="keyword">value</span>属性 或存在<span class="built_in">ref</span>属性或者<span class="keyword">value</span>属性但是又有子元素</span><br><span class="line"><span class="number">3.</span>解析<span class="built_in">ref</span>属性用<span class="type">RuntimeBeanReference</span>封装</span><br><span class="line"><span class="number">4.</span>解析<span class="keyword">value</span>属性用<span class="type">TypedStringValue</span>封装</span><br><span class="line"><span class="number">5.</span>使用parsePropertySubElement对子元素进行处理</span><br></pre></td></tr></table></figure></p>
<p>子元素标签解析<br><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">public</span> <span class="selector-tag">Object</span> <span class="selector-tag">parsePropertySubElement</span>(Element ele, <span class="variable">@Nullable</span> BeanDefinition bd) &#123;</span><br><span class="line">    <span class="selector-tag">return</span> <span class="selector-tag">parsePropertySubElement</span>(ele, bd, null);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Object parsePropertySubElement(Element ele, <span class="meta">@Nullable</span> BeanDefinition bd, <span class="meta">@Nullable</span> String defaultValueType) &#123;</span><br><span class="line">    <span class="comment">// 判断是否使用默认命名空间</span></span><br><span class="line">    <span class="keyword">if</span> (!isDefaultNamespace(ele)) &#123;</span><br><span class="line">        <span class="comment">// 自定义标签解析</span></span><br><span class="line">        <span class="keyword">return</span> parseNestedCustomElement(ele, bd);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (nodeNameEquals(ele, BEAN_ELEMENT)) &#123;</span><br><span class="line">        <span class="comment">// bean标签解析</span></span><br><span class="line">        BeanDefinitionHolder nestedBd = parseBeanDefinitionElement(ele, bd);</span><br><span class="line">        <span class="keyword">if</span> (nestedBd != <span class="literal">null</span>) &#123;</span><br><span class="line">            nestedBd = decorateBeanDefinitionIfRequired(ele, nestedBd, bd);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> nestedBd;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (nodeNameEquals(ele, REF_ELEMENT)) &#123;</span><br><span class="line">        <span class="comment">// ref标签解析</span></span><br><span class="line">        <span class="comment">// 获取ref标签bean属性</span></span><br><span class="line">        String refName = ele.getAttribute(BEAN_REF_ATTRIBUTE);</span><br><span class="line">        boolean toParent = <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">if</span> (!StringUtils.hasLength(refName)) &#123;</span><br><span class="line">            <span class="comment">// 解析ref标签parent属性</span></span><br><span class="line">            refName = ele.getAttribute(PARENT_REF_ATTRIBUTE);</span><br><span class="line">            toParent = <span class="literal">true</span>;</span><br><span class="line">            <span class="keyword">if</span> (!StringUtils.hasLength(refName)) &#123;</span><br><span class="line">                error(<span class="string">"'bean' or 'parent' is required for &lt;ref&gt; element"</span>, ele);</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!StringUtils.hasText(refName)) &#123;</span><br><span class="line">            error(<span class="string">"&lt;ref&gt; element contains empty target attribute"</span>, ele);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        RuntimeBeanReference ref = new RuntimeBeanReference(refName, toParent);</span><br><span class="line">        ref.setSource(extractSource(ele));</span><br><span class="line">        <span class="keyword">return</span> ref;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (nodeNameEquals(ele, IDREF_ELEMENT)) &#123;</span><br><span class="line">        <span class="comment">// idref标签解析</span></span><br><span class="line">        <span class="keyword">return</span> parseIdRefElement(ele);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (nodeNameEquals(ele, VALUE_ELEMENT)) &#123;</span><br><span class="line">        <span class="comment">// value标签解析</span></span><br><span class="line">        <span class="keyword">return</span> parseValueElement(ele, defaultValueType);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (nodeNameEquals(ele, NULL_ELEMENT)) &#123;</span><br><span class="line">        <span class="comment">// null标签解析</span></span><br><span class="line">        TypedStringValue nullHolder = new TypedStringValue(<span class="literal">null</span>);</span><br><span class="line">        nullHolder.setSource(extractSource(ele));</span><br><span class="line">        <span class="keyword">return</span> nullHolder;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (nodeNameEquals(ele, ARRAY_ELEMENT)) &#123;</span><br><span class="line">        <span class="comment">//  array标签解析</span></span><br><span class="line">        <span class="keyword">return</span> parseArrayElement(ele, bd);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (nodeNameEquals(ele, LIST_ELEMENT)) &#123;</span><br><span class="line">        <span class="comment">// list标签解析</span></span><br><span class="line">        <span class="keyword">return</span> parseListElement(ele, bd);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (nodeNameEquals(ele, SET_ELEMENT)) &#123;</span><br><span class="line">        <span class="comment">// set标签解析</span></span><br><span class="line">        <span class="keyword">return</span> parseSetElement(ele, bd);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (nodeNameEquals(ele, MAP_ELEMENT)) &#123;</span><br><span class="line">        <span class="comment">// map标签解析</span></span><br><span class="line">        <span class="keyword">return</span> parseMapElement(ele, bd);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (nodeNameEquals(ele, PROPS_ELEMENT)) &#123;</span><br><span class="line">        <span class="comment">// props标签解析</span></span><br><span class="line">        <span class="keyword">return</span> parsePropsElement(ele);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        error(<span class="string">"Unknown property sub-element: ["</span> + ele.getNodeName() + <span class="string">"]"</span>, ele);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>对property各种子元素处理逻辑请自行分析，不再详述</p>
<p><strong>parsePropertyElements(Element beanEle, BeanDefinition bd) 解析property标签到GenericBeanDefinition中</strong><br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">parsePropertyElements</span><span class="params">(Element beanEle, BeanDefinition bd)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 获取当前节点下的所有子元素</span></span><br><span class="line">    NodeList nl = beanEle.getChildNodes();</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; nl.getLength(); i++) &#123;</span><br><span class="line">        Node node = nl.item(i);</span><br><span class="line">        <span class="keyword">if</span> (isCandidateElement(node) &amp;&amp; nodeNameEquals(node, PROPERTY_ELEMENT)) &#123;</span><br><span class="line">            <span class="comment">// 解析property标签</span></span><br><span class="line">            parsePropertyElement((Element) node, bd);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">parsePropertyElement</span><span class="params">(Element ele, BeanDefinition bd)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 获取name属性</span></span><br><span class="line">    String propertyName = ele.getAttribute(NAME_ATTRIBUTE);</span><br><span class="line">    <span class="keyword">if</span> (!StringUtils.hasLength(propertyName)) &#123;</span><br><span class="line">        <span class="keyword">error</span>(<span class="string">"Tag 'property' must have a 'name' attribute"</span>, ele);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">this</span>.parseState.push(<span class="keyword">new</span> PropertyEntry(propertyName));</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 不允许多次对同一属性配置</span></span><br><span class="line">        <span class="keyword">if</span> (bd.getPropertyValues().contains(propertyName)) &#123;</span><br><span class="line">            <span class="keyword">error</span>(<span class="string">"Multiple 'property' definitions for property '"</span> + propertyName + <span class="string">"'"</span>, ele);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 获取属性元素的值</span></span><br><span class="line">        Object val = parsePropertyValue(ele, bd, propertyName);</span><br><span class="line">        PropertyValue pv = <span class="keyword">new</span> PropertyValue(propertyName, val);</span><br><span class="line">        <span class="comment">// 解析meta标签</span></span><br><span class="line">        parseMetaElements(ele, pv);</span><br><span class="line">        pv.setSource(extractSource(ele));</span><br><span class="line">        bd.getPropertyValues().addPropertyValue(pv);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">this</span>.parseState.pop();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>parseQualifierElements(Element beanEle, AbstractBeanDefinition bd) 解析qualifier标签到GenericBeanDefinition中</strong><br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">parseQualifierElements</span><span class="params">(Element beanEle, AbstractBeanDefinition bd)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 获取当前节点下的所有子元素</span></span><br><span class="line">    NodeList nl = beanEle.getChildNodes();</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; nl.getLength(); i++) &#123;</span><br><span class="line">        Node node = nl.item(i);</span><br><span class="line">        <span class="keyword">if</span> (isCandidateElement(node) &amp;&amp; nodeNameEquals(node, QUALIFIER_ELEMENT)) &#123;</span><br><span class="line">            <span class="comment">// 解析qualifier标签</span></span><br><span class="line">            parseQualifierElement((Element) node, bd);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<figure class="highlight pony"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">public void parseQualifierElement(<span class="type">Element</span> ele, <span class="type">AbstractBeanDefinition</span> bd) &#123;</span><br><span class="line">    <span class="comment">// 获取type属性</span></span><br><span class="line">    <span class="type">String</span> typeName = ele.getAttribute(<span class="type">TYPE_ATTRIBUTE</span>);</span><br><span class="line">    <span class="keyword">if</span> (!<span class="type">StringUtils</span>.hasLength(typeName)) &#123;</span><br><span class="line">        error(<span class="string">"Tag 'qualifier' must have a 'type' attribute"</span>, ele);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="literal">this</span>.parseState.push(<span class="function"><span class="keyword">new</span> <span class="title">QualifierEntry</span>(typeName));</span></span><br><span class="line"><span class="function">    <span class="title">try</span> &#123;</span></span><br><span class="line"><span class="function">        <span class="title">AutowireCandidateQualifier</span> <span class="title">qualifier</span> = <span class="title">new</span> <span class="title">AutowireCandidateQualifier</span>(typeName);</span></span><br><span class="line"><span class="function">        <span class="title">qualifier</span>.<span class="title">setSource</span>(extractSource(ele));</span></span><br><span class="line"><span class="function">        <span class="comment">// 获取value属性</span></span></span><br><span class="line"><span class="function">        <span class="title">String</span> <span class="title">value</span> = <span class="title">ele</span>.<span class="title">getAttribute</span>(<span class="type">VALUE_ATTRIBUTE</span>);</span></span><br><span class="line"><span class="function">        <span class="title">if</span> (<span class="type">StringUtils</span>.hasLength(value)) &#123;</span></span><br><span class="line"><span class="function">            <span class="title">qualifier</span>.<span class="title">setAttribute</span>(<span class="type">AutowireCandidateQualifier</span>.<span class="type">VALUE_KEY</span>, value);</span></span><br><span class="line"><span class="function">        &#125;</span></span><br><span class="line"><span class="function">        <span class="title">NodeList</span> <span class="title">nl</span> = <span class="title">ele</span>.<span class="title">getChildNodes</span>();</span></span><br><span class="line"><span class="function">        <span class="title">for</span> (int i = <span class="number">0</span>; i &lt; nl.getLength(); <span class="title">i</span>++) &#123;</span></span><br><span class="line"><span class="function">            <span class="title">Node</span> <span class="title">node</span> = <span class="title">nl</span>.<span class="title">item</span>(i);</span></span><br><span class="line"><span class="function">            <span class="title">if</span> (isCandidateElement(node) &amp;&amp; <span class="title">nodeNameEquals</span>(node, <span class="type">QUALIFIER_ATTRIBUTE_ELEMENT</span>)) &#123;</span></span><br><span class="line"><span class="function">                <span class="comment">// 解析attribute标签</span></span></span><br><span class="line"><span class="function">                <span class="title">Element</span> <span class="title">attributeEle</span> = (<span class="type">Element</span>) <span class="title">node</span>;</span></span><br><span class="line"><span class="function">                <span class="title">String</span> <span class="title">attributeName</span> = <span class="title">attributeEle</span>.<span class="title">getAttribute</span>(<span class="type">KEY_ATTRIBUTE</span>);</span></span><br><span class="line"><span class="function">                <span class="title">String</span> <span class="title">attributeValue</span> = <span class="title">attributeEle</span>.<span class="title">getAttribute</span>(<span class="type">VALUE_ATTRIBUTE</span>);</span></span><br><span class="line"><span class="function">                <span class="title">if</span> (<span class="type">StringUtils</span>.hasLength(attributeName) &amp;&amp; <span class="title">StringUtils</span>.<span class="title">hasLength</span>(attributeValue)) &#123;</span></span><br><span class="line"><span class="function">                    <span class="title">BeanMetadataAttribute</span> <span class="title">attribute</span> = <span class="title">new</span> <span class="title">BeanMetadataAttribute</span>(attributeName, attributeValue);</span></span><br><span class="line"><span class="function">                    <span class="title">attribute</span>.<span class="title">setSource</span>(extractSource(attributeEle));</span></span><br><span class="line"><span class="function">                    <span class="title">qualifier</span>.<span class="title">addMetadataAttribute</span>(attribute);</span></span><br><span class="line"><span class="function">                &#125; <span class="title">else</span> &#123;</span></span><br><span class="line"><span class="function">                    <span class="title">error</span>("<span class="type">Qualifier</span> 'attribute' tag must have a 'name' and 'value'", attributeEle);</span></span><br><span class="line"><span class="function">                    <span class="title">return</span>;</span></span><br><span class="line"><span class="function">                &#125;</span></span><br><span class="line"><span class="function">            &#125;</span></span><br><span class="line"><span class="function">        &#125;</span></span><br><span class="line"><span class="function">        <span class="title">bd</span>.<span class="title">addQualifier</span>(qualifier);</span></span><br><span class="line"><span class="function">    &#125; <span class="title">finally</span> &#123;</span></span><br><span class="line"><span class="function">        <span class="title">this</span>.<span class="title">parseState</span>.<span class="title">pop</span>();</span></span><br><span class="line"><span class="function">    &#125;</span></span><br><span class="line"><span class="function">&#125;</span></span><br></pre></td></tr></table></figure>
<h3 id="decorateBeanDefinitionIfRequired-Element-ele-BeanDefinitionHolder-definitionHolder"><a href="#decorateBeanDefinitionIfRequired-Element-ele-BeanDefinitionHolder-definitionHolder" class="headerlink" title="decorateBeanDefinitionIfRequired(Element ele, BeanDefinitionHolder definitionHolder)"></a>decorateBeanDefinitionIfRequired(Element ele, BeanDefinitionHolder definitionHolder)</h3><p>当返回的bdHolder不为空的情况下若存在默认标签的子节点下再有自定义属性，还需要再次对自定义标签进行解析，这里有别于自定义类型的解析<br><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function">BeanDefinitionHolder <span class="title">decorateBeanDefinitionIfRequired</span><span class="params">(Element ele, BeanDefinitionHolder definitionHolder)</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">return</span> <span class="title">decorateBeanDefinitionIfRequired</span><span class="params">(ele, definitionHolder, <span class="keyword">null</span>)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> BeanDefinitionHolder <span class="title">decorateBeanDefinitionIfRequired</span><span class="params">(Element ele, BeanDefinitionHolder definitionHolder, @Nullable BeanDefinition containingBd)</span> </span>&#123;</span><br><span class="line">    BeanDefinitionHolder finalDefinition = definitionHolder;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 遍历所有属性 查看是否有适用于修饰的属性</span></span><br><span class="line">    NamedNodeMap attributes = ele.getAttributes();</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; attributes.getLength(); i++) &#123;</span><br><span class="line">        Node node = attributes.item(i);</span><br><span class="line">        finalDefinition = decorateIfRequired(node, finalDefinition, containingBd);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 遍历所有的子节点 判断是否有适用于修饰的子元素</span></span><br><span class="line">    NodeList children = ele.getChildNodes();</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; children.getLength(); i++) &#123;</span><br><span class="line">        Node node = children.item(i);</span><br><span class="line">        <span class="keyword">if</span> (node.getNodeType() == Node.ELEMENT_NODE) &#123;</span><br><span class="line">            finalDefinition = decorateIfRequired(node, finalDefinition, containingBd);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> finalDefinition;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function">BeanDefinitionHolder <span class="title">decorateIfRequired</span><span class="params">(Node node, BeanDefinitionHolder originalDef, @Nullable BeanDefinition containingBd)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 获取自定义标签的命名空间</span></span><br><span class="line">    String namespaceUri = getNamespaceURI(node);</span><br><span class="line">    <span class="comment">// 对于非默认标签进行装饰</span></span><br><span class="line">    <span class="keyword">if</span> (namespaceUri != <span class="keyword">null</span> &amp;&amp; !isDefaultNamespace(namespaceUri)) &#123;</span><br><span class="line">        <span class="comment">// 根据命名空间找到对应的处理器</span></span><br><span class="line">        NamespaceHandler <span class="keyword">handler</span> = <span class="keyword">this</span>.readerContext.getNamespaceHandlerResolver().resolve(namespaceUri);</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">handler</span> != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">// 进行修饰</span></span><br><span class="line">            BeanDefinitionHolder decorated = <span class="keyword">handler</span>.decorate(node, originalDef, <span class="keyword">new</span> ParserContext(<span class="keyword">this</span>.readerContext, <span class="keyword">this</span>, containingBd));</span><br><span class="line">            <span class="keyword">if</span> (decorated != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> decorated;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (namespaceUri.startsWith(<span class="string">"http://www.springframework.org/"</span>)) &#123;</span><br><span class="line">            <span class="keyword">error</span>(<span class="string">"Unable to locate Spring NamespaceHandler for XML schema namespace ["</span> + namespaceUri + <span class="string">"]"</span>, node);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">                logger.debug(<span class="string">"No Spring NamespaceHandler found for XML schema namespace ["</span> + namespaceUri + <span class="string">"]"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> originalDef;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="registerBeanDefinition-BeanDefinitionHolder-definitionHolder-BeanDefinitionRegistry-registry"><a href="#registerBeanDefinition-BeanDefinitionHolder-definitionHolder-BeanDefinitionRegistry-registry" class="headerlink" title="registerBeanDefinition(BeanDefinitionHolder definitionHolder, BeanDefinitionRegistry registry)"></a>registerBeanDefinition(BeanDefinitionHolder definitionHolder, BeanDefinitionRegistry registry)</h3><p>在解析完配置文件后我们已经获取了bean的所有属性，接下来就是对bean的注册了<br><figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">public</span> static void registerBeanDefinition( <span class="keyword">BeanDefinitionHolder </span>definitionHolder, <span class="keyword">BeanDefinitionRegistry </span>registry) throws <span class="keyword">BeanDefinitionStoreException </span>&#123;</span><br><span class="line">    // 使用<span class="keyword">beanName做唯一标识符</span></span><br><span class="line"><span class="keyword"> </span>   <span class="keyword">String </span><span class="keyword">beanName </span>= definitionHolder.getBeanName()<span class="comment">;</span></span><br><span class="line">    // 注册<span class="keyword">bean的核心代码</span></span><br><span class="line"><span class="keyword"> </span>   registry.registerBeanDefinition(<span class="keyword">beanName, </span>definitionHolder.getBeanDefinition())<span class="comment">;</span></span><br><span class="line">    // 为<span class="keyword">bean注册所有的别名</span></span><br><span class="line"><span class="keyword"> </span>   <span class="keyword">String[] </span>aliases = definitionHolder.getAliases()<span class="comment">;</span></span><br><span class="line">    <span class="meta">if</span> (aliases != null) &#123;</span><br><span class="line">        for (<span class="keyword">String </span><span class="meta">alias</span> : aliases) &#123;</span><br><span class="line">            registry.registerAlias(<span class="keyword">beanName, </span><span class="meta">alias</span>)<span class="comment">;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>以上代码主要完成两个功能，一是使用beanName注册beanDefinition，二是完成了对别名的注册</p>
<p>使用beanName注册beanDefinition<br><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> void registerBeanDefinition(String beanName, BeanDefinition beanDefinition) throws BeanDefinitionStoreException &#123;</span><br><span class="line">    Assert.hasText(beanName, <span class="string">"Bean name must not be empty"</span>);</span><br><span class="line">    Assert.notNull(beanDefinition, <span class="string">"BeanDefinition must not be null"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (beanDefinition instanceof AbstractBeanDefinition) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 注册前的最后一次校验，这里的校验不同于XML文件校验</span></span><br><span class="line">            <span class="comment">// 主要是对于AbstractBeanDefinition属性中的methodOverrides校验</span></span><br><span class="line">            <span class="comment">// 校验methodOverrides是否与工厂方法并存或者methodOverrides对于的方法根本不存在</span></span><br><span class="line">            ((AbstractBeanDefinition) beanDefinition).validate();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (BeanDefinitionValidationException ex) &#123;</span><br><span class="line">            <span class="keyword">throw</span> new BeanDefinitionStoreException(beanDefinition.getResourceDescription(), beanName, <span class="string">"Validation of bean definition failed"</span>, ex);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    BeanDefinition oldBeanDefinition;</span><br><span class="line">    <span class="comment">// 获取缓存中的beanDefinition</span></span><br><span class="line">    oldBeanDefinition = <span class="keyword">this</span>.beanDefinitionMap.<span class="keyword">get</span>(beanName);</span><br><span class="line">    <span class="keyword">if</span> (oldBeanDefinition != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// 如果缓存中存在 判断是否允许覆盖</span></span><br><span class="line">        <span class="keyword">if</span> (!isAllowBeanDefinitionOverriding()) &#123;</span><br><span class="line">            <span class="keyword">throw</span> new BeanDefinitionStoreException(beanDefinition.getResourceDescription(), beanName, <span class="string">"Cannot register bean definition ["</span> + beanDefinition + <span class="string">"] for bean '"</span> + beanName + <span class="string">"': There is already ["</span> + oldBeanDefinition + <span class="string">"] bound."</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (oldBeanDefinition.getRole() &lt; beanDefinition.getRole()) &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">this</span>.logger.isWarnEnabled()) &#123;</span><br><span class="line">                <span class="keyword">this</span>.logger.warn(<span class="string">"Overriding user-defined bean definition for bean '"</span> + beanName + <span class="string">"' with a framework-generated bean definition: replacing ["</span> + oldBeanDefinition + <span class="string">"] with ["</span> + beanDefinition + <span class="string">"]"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!beanDefinition.equals(oldBeanDefinition)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">this</span>.logger.isInfoEnabled()) &#123;</span><br><span class="line">                <span class="keyword">this</span>.logger.info(<span class="string">"Overriding bean definition for bean '"</span> + beanName + <span class="string">"' with a different definition: replacing ["</span> + oldBeanDefinition + <span class="string">"] with ["</span> + beanDefinition + <span class="string">"]"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">this</span>.logger.isDebugEnabled()) &#123;</span><br><span class="line">                <span class="keyword">this</span>.logger.debug(<span class="string">"Overriding bean definition for bean '"</span> + beanName + <span class="string">"' with an equivalent definition: replacing ["</span> + oldBeanDefinition + <span class="string">"] with ["</span> + beanDefinition + <span class="string">"]"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 如果允许覆盖，保存beanDefinition到beanDefinitionMap中</span></span><br><span class="line">        <span class="keyword">this</span>.beanDefinitionMap.put(beanName, beanDefinition);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 判断是否已经开始创建bean</span></span><br><span class="line">        <span class="keyword">if</span> (hasBeanCreationStarted()) &#123;</span><br><span class="line">            synchronized (<span class="keyword">this</span>.beanDefinitionMap) &#123;</span><br><span class="line">                <span class="comment">// 保存beanDefinition到beanDefinitionMap中</span></span><br><span class="line">                <span class="keyword">this</span>.beanDefinitionMap.put(beanName, beanDefinition);</span><br><span class="line">                <span class="comment">// 更新已经注册的beanName</span></span><br><span class="line">                List&lt;String&gt; updatedDefinitions = new ArrayList&lt;&gt;(<span class="keyword">this</span>.beanDefinitionNames.size() + <span class="number">1</span>);</span><br><span class="line">                updatedDefinitions.addAll(<span class="keyword">this</span>.beanDefinitionNames);</span><br><span class="line">                updatedDefinitions.add(beanName);</span><br><span class="line">                <span class="keyword">this</span>.beanDefinitionNames = updatedDefinitions;</span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">this</span>.manualSingletonNames.contains(beanName)) &#123;</span><br><span class="line">                    Set&lt;String&gt; updatedSingletons = new LinkedHashSet&lt;&gt;(<span class="keyword">this</span>.manualSingletonNames);</span><br><span class="line">                    updatedSingletons.remove(beanName);</span><br><span class="line">                    <span class="keyword">this</span>.manualSingletonNames = updatedSingletons;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 还没开始创建bean</span></span><br><span class="line">            <span class="keyword">this</span>.beanDefinitionMap.put(beanName, beanDefinition);</span><br><span class="line">            <span class="keyword">this</span>.beanDefinitionNames.add(beanName);</span><br><span class="line">            <span class="keyword">this</span>.manualSingletonNames.remove(beanName);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">this</span>.frozenBeanDefinitionNames = <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (oldBeanDefinition != <span class="literal">null</span> || containsSingleton(beanName)) &#123;</span><br><span class="line">        <span class="comment">// 重置beanName对应的缓存</span></span><br><span class="line">        resetBeanDefinition(beanName);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>使用beanName注册beanDefinition主要完成了以下几个功能<br><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span>对AbstractBeanDefinition的校验，主要是针对AbstractBeanDefinition的methodOverrides属性的</span><br><span class="line"><span class="number">2.</span>对beanName已经注册的情况的处理，如果设置了不允许bean的覆盖，则需要抛出异常，否则直接覆盖</span><br><span class="line"><span class="number">3.</span>使用beanName作为<span class="type">key</span>，beanDefinition为Value加入beanDefinitionMap存储</span><br><span class="line"><span class="number">4.</span>如果缓存中已经存在，并且该bean为单例模式则清楚beanName对应的缓存</span><br></pre></td></tr></table></figure></p>
<p>注册别名<br><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">registerAlias</span>(<span class="params">String name, String <span class="keyword">alias</span></span>) </span>&#123;</span><br><span class="line">    Assert.hasText(name, <span class="string">"'name' must not be empty"</span>);</span><br><span class="line">    Assert.hasText(<span class="keyword">alias</span>, <span class="string">"'alias' must not be empty"</span>);</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">alias</span>.<span class="keyword">equals</span>(name)) &#123;</span><br><span class="line">        <span class="comment">// 如果beanName与alias相同的话不记录alias 并删除对应的alias</span></span><br><span class="line">        <span class="keyword">this</span>.aliasMap.<span class="keyword">remove</span>(<span class="keyword">alias</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        String registeredName = <span class="keyword">this</span>.aliasMap.<span class="keyword">get</span>(<span class="keyword">alias</span>);</span><br><span class="line">        <span class="keyword">if</span> (registeredName != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (registeredName.<span class="keyword">equals</span>(name)) &#123;</span><br><span class="line">                <span class="comment">// 如果别名已经注册过并且指向的name和当前name相同 不做任何处理</span></span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 如果alias不允许被覆盖则抛出异常</span></span><br><span class="line">            <span class="keyword">if</span> (!allowAliasOverriding()) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Cannot register alias '"</span> + <span class="keyword">alias</span> + <span class="string">"' for name '"</span> + name + <span class="string">"': It is already registered for name '"</span> + registeredName + <span class="string">"'."</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 校验循环指向依赖 如A-&gt;B B-&gt;C C-&gt;A则出错</span></span><br><span class="line">        checkForAliasCircle(name, <span class="keyword">alias</span>);</span><br><span class="line">        <span class="keyword">this</span>.aliasMap.put(<span class="keyword">alias</span>, name);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>注册别名主要完成了以下工作<br><figure class="highlight delphi"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>.如果beanName与<span class="keyword">alias</span>相同的话不记录<span class="keyword">alias</span> 并删除对应的<span class="keyword">alias</span></span><br><span class="line"><span class="number">2</span>.如果别名已经注册过并且指向的<span class="keyword">name</span>和当前<span class="keyword">name</span>相同 不做任何处理</span><br><span class="line"><span class="number">3</span>.如果别名已经注册过并且指向的<span class="keyword">name</span>和当前<span class="keyword">name</span>不相同 判断是否允许被覆盖</span><br><span class="line"><span class="number">4</span>.校验循环指向依赖 如A-&gt;B B-&gt;C C-&gt;A则出错</span><br></pre></td></tr></table></figure></p>
<h3 id="fireComponentRegistered-ComponentDefinition-componentDefinition"><a href="#fireComponentRegistered-ComponentDefinition-componentDefinition" class="headerlink" title="fireComponentRegistered(ComponentDefinition componentDefinition)"></a>fireComponentRegistered(ComponentDefinition componentDefinition)</h3><p>通过fireComponentRegistered方法进行通知监听器解析及注册完成工作，这里的实现只为扩展，当程序开发人员需要对注册BeanDefinition事件进行监听时，可以通过注册监听器的方式并将处理逻辑写入监听器中，目前Spring中并没有对此事件做任何处理</p>
<h2 id="alias标签解析"><a href="#alias标签解析" class="headerlink" title="alias标签解析"></a>alias标签解析</h2><p>Spring提供了&lt;alias name=”testBean” alias=”testBeanAlias” /&gt;方式来进行别名的配置，该标签解析是在processAliasRegistration(Element ele)方法中完成的<br><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">processAliasRegistration</span>(<span class="params">Element ele</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// 获取alisa标签name属性</span></span><br><span class="line">    String name = ele.getAttribute(NAME_ATTRIBUTE);</span><br><span class="line">    <span class="comment">// 获取alisa标签alias属性</span></span><br><span class="line">    String <span class="keyword">alias</span> = ele.getAttribute(ALIAS_ATTRIBUTE);</span><br><span class="line">    boolean valid = <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">if</span> (!StringUtils.hasText(name)) &#123;</span><br><span class="line">        getReaderContext().error(<span class="string">"Name must not be empty"</span>, ele);</span><br><span class="line">        valid = <span class="literal">false</span>;</span><br><span class="line">    &#125; <span class="keyword">if</span> (!StringUtils.hasText(<span class="keyword">alias</span>)) &#123;</span><br><span class="line">        getReaderContext().error(<span class="string">"Alias must not be empty"</span>, ele);</span><br><span class="line">        valid = <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (valid) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 进行别名注册</span></span><br><span class="line">            getReaderContext().getRegistry().registerAlias(name, <span class="keyword">alias</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">            getReaderContext().error(<span class="string">"Failed to register alias '"</span> + <span class="keyword">alias</span> +</span><br><span class="line">                    <span class="string">"' for bean with name '"</span> + name + <span class="string">"'"</span>, ele, ex);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 别名注册后告知监听器做相应处理</span></span><br><span class="line">        getReaderContext().fireAliasRegistered(name, <span class="keyword">alias</span>, extractSource(ele));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>该方法首先对alias标签属性进行提取校验，校验通过后进行别名注册，别名注册和bean标签解析中的别名注册一直，此处不再赘述</p>
<h2 id="import标签解析"><a href="#import标签解析" class="headerlink" title="import标签解析"></a>import标签解析</h2><figure class="highlight pony"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line">protected void importBeanDefinitionResource(<span class="type">Element</span> ele) &#123;</span><br><span class="line">    <span class="comment">// 获取import标签的resource属性</span></span><br><span class="line">    <span class="type">String</span> location = ele.getAttribute(<span class="type">RESOURCE_ATTRIBUTE</span>);</span><br><span class="line">    <span class="comment">// 如果不存在则不做任何处理</span></span><br><span class="line">    <span class="keyword">if</span> (!<span class="type">StringUtils</span>.hasText(location)) &#123;</span><br><span class="line">        getReaderContext().error(<span class="string">"Resource location must not be empty"</span>, ele);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 解析占位符属性 格式如"$&#123;user.dir&#125;"</span></span><br><span class="line">    location = getReaderContext().getEnvironment().resolveRequiredPlaceholders(location);</span><br><span class="line"></span><br><span class="line">    <span class="type">Set</span>&lt;<span class="type">Resource</span>&gt; actualResources = <span class="function"><span class="keyword">new</span> <span class="title">LinkedHashSet</span>&lt;&gt;(<span class="number">4</span>);</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">    <span class="comment">// 判断资源是绝对路径还是相对路径</span></span></span><br><span class="line"><span class="function">    <span class="title">boolean</span> <span class="title">absoluteLocation</span> = <span class="title">false</span>;</span></span><br><span class="line"><span class="function">    <span class="title">try</span> &#123;</span></span><br><span class="line"><span class="function">        <span class="title">absoluteLocation</span> = <span class="title">ResourcePatternUtils</span>.<span class="title">isUrl</span>(location) || <span class="title">ResourceUtils</span>.<span class="title">toURI</span>(location).<span class="title">isAbsolute</span>();</span></span><br><span class="line"><span class="function">    &#125; <span class="title">catch</span> (<span class="type">URISyntaxException</span> ex) &#123;</span></span><br><span class="line"><span class="function">        <span class="comment">// cannot convert to an URI, considering the location relative</span></span></span><br><span class="line"><span class="function">        <span class="comment">// unless it is the well-known Spring prefix "classpath*:"</span></span></span><br><span class="line"><span class="function">    &#125;</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">    <span class="comment">// 如果是绝对路径则直接根据地址加载对应的配置文件</span></span></span><br><span class="line"><span class="function">    <span class="title">if</span> (absoluteLocation) &#123;</span></span><br><span class="line"><span class="function">        <span class="title">try</span> &#123;</span></span><br><span class="line"><span class="function">            <span class="title">int</span> <span class="title">importCount</span> = <span class="title">getReaderContext</span>().<span class="title">getReader</span>().<span class="title">loadBeanDefinitions</span>(location, actualResources);</span></span><br><span class="line"><span class="function">            <span class="title">if</span> (logger.isDebugEnabled()) &#123;</span></span><br><span class="line"><span class="function">                <span class="title">logger</span>.<span class="title">debug</span>("<span class="type">Imported</span> " + importCount + " bean definitions from <span class="type">URL</span> location [" + location + "]");</span></span><br><span class="line"><span class="function">            &#125;</span></span><br><span class="line"><span class="function">        &#125; <span class="title">catch</span> (<span class="type">BeanDefinitionStoreException</span> ex) &#123;</span></span><br><span class="line"><span class="function">            <span class="title">getReaderContext</span>().<span class="title">error</span>("<span class="type">Failed</span> to import bean definitions from <span class="type">URL</span> location [" + location + "]", ele, ex);</span></span><br><span class="line"><span class="function">        &#125;</span></span><br><span class="line"><span class="function">    &#125; <span class="title">else</span> &#123;</span></span><br><span class="line"><span class="function">        <span class="title">try</span> &#123;</span></span><br><span class="line"><span class="function">            <span class="title">int</span> <span class="title">importCount</span>;</span></span><br><span class="line"><span class="function">            <span class="comment">// 根据相对路径加载资源</span></span></span><br><span class="line"><span class="function">            <span class="title">Resource</span> <span class="title">relativeResource</span> = <span class="title">getReaderContext</span>().<span class="title">getResource</span>().<span class="title">createRelative</span>(location);</span></span><br><span class="line"><span class="function">            <span class="title">if</span> (relativeResource.exists()) &#123;</span></span><br><span class="line"><span class="function">                <span class="title">importCount</span> = <span class="title">getReaderContext</span>().<span class="title">getReader</span>().<span class="title">loadBeanDefinitions</span>(relativeResource);</span></span><br><span class="line"><span class="function">                <span class="title">actualResources</span>.<span class="title">add</span>(relativeResource);</span></span><br><span class="line"><span class="function">            &#125; <span class="title">else</span> &#123;</span></span><br><span class="line"><span class="function">                <span class="title">String</span> <span class="title">baseLocation</span> = <span class="title">getReaderContext</span>().<span class="title">getResource</span>().<span class="title">getURL</span>().<span class="title">toString</span>();</span></span><br><span class="line"><span class="function">                <span class="title">importCount</span> = <span class="title">getReaderContext</span>().<span class="title">getReader</span>().<span class="title">loadBeanDefinitions</span>(<span class="type">StringUtils</span>.applyRelativePath(baseLocation, location), <span class="title">actualResources</span>);</span></span><br><span class="line"><span class="function">            &#125;</span></span><br><span class="line"><span class="function">            <span class="title">if</span> (logger.isDebugEnabled()) &#123;</span></span><br><span class="line"><span class="function">                <span class="title">logger</span>.<span class="title">debug</span>("<span class="type">Imported</span> " + importCount + " bean definitions from relative location [" + location + "]");</span></span><br><span class="line"><span class="function">            &#125;</span></span><br><span class="line"><span class="function">        &#125; <span class="title">catch</span> (<span class="type">IOException</span> ex) &#123;</span></span><br><span class="line"><span class="function">            <span class="title">getReaderContext</span>().<span class="title">error</span>("<span class="type">Failed</span> to resolve current resource location", ele, ex);</span></span><br><span class="line"><span class="function">        &#125; <span class="title">catch</span> (<span class="type">BeanDefinitionStoreException</span> ex) &#123;</span></span><br><span class="line"><span class="function">            <span class="title">getReaderContext</span>().<span class="title">error</span>("<span class="type">Failed</span> to import bean definitions from relative location [" + location + "]", ele, ex);</span></span><br><span class="line"><span class="function">        &#125;</span></span><br><span class="line"><span class="function">    &#125;</span></span><br><span class="line"><span class="function">    <span class="comment">// 解析后进行监听器激活处理</span></span></span><br><span class="line"><span class="function">    <span class="title">Resource</span>[] <span class="title">actResArray</span> = <span class="title">actualResources</span>.<span class="title">toArray</span>(new <span class="type">Resource</span>[actualResources.size()]);</span></span><br><span class="line"><span class="function">    <span class="title">getReaderContext</span>().<span class="title">fireImportProcessed</span>(location, actResArray, extractSource(ele));</span></span><br><span class="line"><span class="function">&#125;</span></span><br></pre></td></tr></table></figure>
<p>以上代码完成了对import标签的处理，大致步骤如下<br><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span>获取resource属性所表示的路径</span><br><span class="line"><span class="number">2.</span>解析路径中的属性占位符 如<span class="string">"$&#123;user.dir&#125;"</span></span><br><span class="line"><span class="number">3.</span>判定location是绝对路径还是相对路径</span><br><span class="line"><span class="number">4.</span>如果是绝对路径则递归调用bean的解析过程，进行另一次解析</span><br><span class="line"><span class="number">5.</span>如果是相对路径则计算出绝对路径并进行解析</span><br><span class="line"><span class="number">6.</span>通知监听器，解析完成</span><br></pre></td></tr></table></figure></p>
<h2 id="beans标签解析"><a href="#beans标签解析" class="headerlink" title="beans标签解析"></a>beans标签解析</h2><p>嵌入式beans标签与单独配置文件并没有太大差别，其原理是递归调用了beans的解析过程</p>

        
        </div>
        <footer class="article-footer">
            <div class="share-container">

    <div class="jiathis_style">
    <span class="jiathis_txt">分享到：</span>
    <a class="jiathis_button_qzone">QQ空间</a>
    <a class="jiathis_button_tsina">新浪微博</a>
    <a class="jiathis_button_tqq">腾讯微博</a>
    <a class="jiathis_button_weixin">微信</a>
    <a href="http://www.jiathis.com/share" class="jiathis jiathis_txt jiathis_separator jtico jtico_jiathis" target="_blank">更多</a>
    <a class="jiathis_counter_style"></a>
</div>
<script type="text/javascript" src="http://v3.jiathis.com/code/jia.js" charset="utf-8"></script>
<style>
    .jiathis_style div:first-child:not(.jiadiv_01) {
        width: auto !important;
        border: none !important;
    }
    .jiathis_style .jiadiv_01 {
        margin: 10px 0;
        border-radius: 4px;
        border: #e1e1e1 solid 1px;
    }
    .jiathis_style .jiadiv_01 div:first-child {
        display: none;
    }
    .jiathis_style .jiadiv_02 {
        padding: 7px 0 !important;
    }
    .jiathis_style .jiadiv_02 .jiatitle {
        width: 85px;
        border: none;
        height: auto;
        margin: 3px 10px;
        padding: 6px 10px;
        border-radius: 4px;
    }
    .jiathis_style .jiadiv_02 .jiatitle:hover {
        border: none;
    }
    .jiathis_style .jiadiv_02 .jiatitle:nth-child(even) {
        margin-left: 0;
    }
    .jiathis_style .jtico:hover {
        opacity: 1;
    }
    .jiathis_style .ckepopBottom,
    .jiathis_style .centerBottom {
        width: auto !important;
        padding: 5px;
        background: #f7f7f7;
    }
</style>



</div>

            <!-- 
    
        <a href="http://huangth.com/2017/12/27/03.Spring IOC源码深度解析之默认标签的解析/#comments" id="sourceId::2017/12/27/03.Spring IOC源码深度解析之默认标签的解析/" class="article-comment-link cy_cmt_count">评论</a>
    
 -->
        </footer>
    </div>
    
        
<nav id="article-nav">
    
        <a href="/2018/03/08/01.Spring AOP面向切面编程详解(基于XML方式 注解方式 注入Aspectj方式)/" id="article-nav-newer" class="article-nav-link-wrap">
            <strong class="article-nav-caption">上一篇</strong>
            <div class="article-nav-title">
                
                    01.Spring AOP面向切面编程详解(基于XML方式 注解方式 注入Aspectj方式)
                
            </div>
        </a>
    
    
        <a href="/2017/12/23/02.Spring IOC源码深度解析之容器的基本实现/" id="article-nav-older" class="article-nav-link-wrap">
            <strong class="article-nav-caption">下一篇</strong>
            <div class="article-nav-title">02.Spring IOC源码深度解析之容器的基本实现</div>
        </a>
    
</nav>


    
</article>


    
    
        <section id="comments">
	<div style="text-align: center">
		<button id="rewardButton" ,="" disable="enable" onclick="var qr = document.getElementById('QR'); if (qr.style.display === 'none') {qr.style.display='block';} else {qr.style.display='none'}" style="cursor: pointer; border: 0; outline: 0; border-radius: 100%; padding: 0; margin: 0; letter-spacing: normal; text-transform: none; text-indent: 0px; text-shadow: none">
			<span onmouseover="this.style.color='rgb(236,96,0)';this.style.background='rgb(204,204,204)'" onmouseout="this.style.color='#fff';this.style.background='rgb(236,96,0)'" style="display: inline-block; width: 70px; height: 70px; border-radius: 100%; color: rgb(255, 255, 255); font-weight: 400; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-stretch: normal; font-size: 35px; line-height: 75px; font-family: microsofty; background: rgb(236, 96, 0);">赏</span>
		</button>
		<div id="QR" style="display: none;">
			<div id="wechat" style="display: inline-block">
				<a href="/images/wx.jpg" class="fancybox" rel="group"><img id="wechat_qr" src="http://oxje1v37b.bkt.clouddn.com/%E5%BE%AE%E4%BF%A1%E4%BA%8C%E7%BB%B4%E7%A0%81.png" style="width: 200px; max-width: 100%; display: inline-block"></a>
				<p>微信打赏</p>
				<a href="/images/zfb.png" class="fancybox" rel="group"><img id="wechat_qr" src="http://oxje1v37b.bkt.clouddn.com/%E6%94%AF%E4%BB%98%E5%AE%9D%E4%BA%8C%E7%BB%B4%E7%A0%81.png" style="width: 200px; max-width: 100%; display: inline-block"></a>
				<p>支付宝打赏</p>
			</div>
		</div>
	</div>
    <div id="SOHUCS" sid="2017/12/27/03.Spring IOC源码深度解析之默认标签的解析/">
		
	</div>
</section>
    

</section>
            
                
<aside id="sidebar">
	<div style="margin-top:25px">
		<div class="widget">
             <div class="textwidget" style="background-color: #f5f5f5; color: #a86767;border-radius: 21px;box-shadow: 0 2px 5px 0 rgba(0, 0, 0, 0.16), 0 2px 10px 0 rgba(0, 0, 0, 0.12);padding: 15px;">
				<div style="text-align:center">
					<div class="time" style="color:#f95b39"> 
						<script type="text/javascript">
							today=new Date();
							var day; var date; var hello;
							hour=new Date().getHours()
							if(hour < 6)hello='  凌晨好! '
							else if(hour < 9)hello=' 早上好! '
							else if(hour < 12)hello=' 上午好! '
							else if(hour < 14)hello=' 中午好! '
							else if(hour < 17)hello=' 下午好! '
							else if(hour < 19)hello=' 傍晚好! '
							else if(hour < 22)hello=' 晚上好! '
							else {hello='夜深了! '}
							var webUrl = webUrl;
							document.write(' '+hello);
						</script> 
						<span id="localtime"> 
							<script type="text/javascript">
						　		today=new Date(); var tdate,tday, x,year; var x = new Array("星期日", "星期一", "星期二", "星期三", "星期四", "星期五","星期六");
						　　	var MSIE=navigator.userAgent.indexOf("MSIE");
						　　	if(MSIE != -1)
						　　 		year =(today.getFullYear());
						　　	else
						　　 		year = (today.getYear()+1900);
						　　	tdate= year+ "年" + (today.getMonth() + 1 ) + "月" + today.getDate() + "日" + " " + x[today.getDay()];
						　　	document.write(tdate); 
							</script>
						</span> 
					</div> 
			<!--
				<p><img src="/images/wxh.png" width="60px" height="60px"><br> 微信扫码加我微信<br></p> 
				<p>【Tel:18616365668 QQ:2508203324】</p>
				<p>【Spring Cloud中国QQ群①:<a href="#">415028731</a>】</p>
				<p>【Spring Cloud中国QQ群②:<a href="#">530321604</a>】</p><br>
				<p>系列文章<br> 
				<a href="http://xujin.org/categories/%E8%B7%9F%E6%88%91%E5%AD%A6Spring-Cloud/" style="color: #FF920B">●《跟我学Spring Cloud》</a><br> 
				<a href="http://xujin.org/tags/Spring-Cloud-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/" style="color:#FF920B">●《Spring Cloud源码分析》</a></p> 
				<a href="http://xujin.org/categories/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/" style="color:#FF920B">●《并发编程》</a><p></p> 
				<p>微信公众号：搜索"xujin"或扫描下面的二维码：<br> <img src="/images/wxgzh.png" width="150px" height="150px"></p> 
			-->
			</div> 
		</div>
	</div>
	
		
    <div class="widget-wrap">
        <h3 class="widget-title">最新文章</h3>
        <div class="widget">
            <ul id="recent-post" class="">
                
                    <li>
                        
                        <div class="item-thumbnail">
                            <a href="/2018/03/08/01.Spring AOP面向切面编程详解(基于XML方式 注解方式 注入Aspectj方式)/" class="thumbnail">
    
    
        <span style="background-image:url(http://oxje1v37b.bkt.clouddn.com/Spring%E6%BA%90%E7%A0%81%E6%B7%B1%E5%BA%A6%E8%A7%A3%E6%9E%90%E5%B0%81%E9%9D%A2.jpg)" alt="01.Spring AOP面向切面编程详解(基于XML方式 注解方式 注入Aspectj方式)" class="thumbnail-image"></span>
    
</a>

                        </div>
                        
                        <div class="item-inner">
                            <p class="item-category"><a class="article-category-link" href="/categories/Spring学习笔记/">Spring学习笔记</a></p>
                            <p class="item-title"><a href="/2018/03/08/01.Spring AOP面向切面编程详解(基于XML方式 注解方式 注入Aspectj方式)/" class="title">01.Spring AOP面向切面编程详解(基于XML方式 注解方式 注入Aspectj方式)</a></p>
                            <p class="item-date"><time datetime="2018-03-08T04:00:00.000Z" itemprop="datePublished">2018-03-08</time></p>
                        </div>
                    </li>
                
                    <li>
                        
                        <div class="item-thumbnail">
                            <a href="/2017/12/27/03.Spring IOC源码深度解析之默认标签的解析/" class="thumbnail">
    
    
        <span style="background-image:url(http://oxje1v37b.bkt.clouddn.com/Spring%E6%BA%90%E7%A0%81%E6%B7%B1%E5%BA%A6%E8%A7%A3%E6%9E%90%E5%B0%81%E9%9D%A2.jpg)" alt="03.Spring IOC源码深度解析之默认标签的解析" class="thumbnail-image"></span>
    
</a>

                        </div>
                        
                        <div class="item-inner">
                            <p class="item-category"><a class="article-category-link" href="/categories/Spring源码深度解析/">Spring源码深度解析</a></p>
                            <p class="item-title"><a href="/2017/12/27/03.Spring IOC源码深度解析之默认标签的解析/" class="title">03.Spring IOC源码深度解析之默认标签的解析</a></p>
                            <p class="item-date"><time datetime="2017-12-27T04:00:00.000Z" itemprop="datePublished">2017-12-27</time></p>
                        </div>
                    </li>
                
                    <li>
                        
                        <div class="item-thumbnail">
                            <a href="/2017/12/23/02.Spring IOC源码深度解析之容器的基本实现/" class="thumbnail">
    
    
        <span style="background-image:url(http://oxje1v37b.bkt.clouddn.com/Spring%E6%BA%90%E7%A0%81%E6%B7%B1%E5%BA%A6%E8%A7%A3%E6%9E%90%E5%B0%81%E9%9D%A2.jpg)" alt="02.Spring IOC源码深度解析之容器的基本实现" class="thumbnail-image"></span>
    
</a>

                        </div>
                        
                        <div class="item-inner">
                            <p class="item-category"><a class="article-category-link" href="/categories/Spring源码深度解析/">Spring源码深度解析</a></p>
                            <p class="item-title"><a href="/2017/12/23/02.Spring IOC源码深度解析之容器的基本实现/" class="title">02.Spring IOC源码深度解析之容器的基本实现</a></p>
                            <p class="item-date"><time datetime="2017-12-23T04:00:00.000Z" itemprop="datePublished">2017-12-23</time></p>
                        </div>
                    </li>
                
                    <li>
                        
                        <div class="item-thumbnail">
                            <a href="/2017/12/22/01.Spring源码深度解析之IDEA源码阅读环境搭建/" class="thumbnail">
    
    
        <span style="background-image:url(http://oxje1v37b.bkt.clouddn.com/Spring%E6%BA%90%E7%A0%81%E6%B7%B1%E5%BA%A6%E8%A7%A3%E6%9E%90%E5%B0%81%E9%9D%A2.jpg)" alt="01.Spring源码深度解析之IDEA源码阅读环境搭建" class="thumbnail-image"></span>
    
</a>

                        </div>
                        
                        <div class="item-inner">
                            <p class="item-category"><a class="article-category-link" href="/categories/Spring源码深度解析/">Spring源码深度解析</a></p>
                            <p class="item-title"><a href="/2017/12/22/01.Spring源码深度解析之IDEA源码阅读环境搭建/" class="title">01.Spring源码深度解析之IDEA源码阅读环境搭建</a></p>
                            <p class="item-date"><time datetime="2017-12-22T04:00:00.000Z" itemprop="datePublished">2017-12-22</time></p>
                        </div>
                    </li>
                
                    <li>
                        
                        <div class="item-thumbnail">
                            <a href="/2017/12/12/前辈分享的经典语句/" class="thumbnail">
    
    
        <span style="background-image:url(http://oxje1v37b.bkt.clouddn.com/Java%E5%89%8D%E8%BE%88%E5%88%86%E4%BA%AB%E7%9A%84%E7%BB%8F%E5%85%B8%E8%AF%AD%E5%8F%A5.jpg)" alt="前辈分享的经典语句" class="thumbnail-image"></span>
    
</a>

                        </div>
                        
                        <div class="item-inner">
                            <p class="item-category"><a class="article-category-link" href="/categories/个人博客/">个人博客</a></p>
                            <p class="item-title"><a href="/2017/12/12/前辈分享的经典语句/" class="title">前辈分享的经典语句</a></p>
                            <p class="item-date"><time datetime="2017-12-12T04:12:12.000Z" itemprop="datePublished">2017-12-12</time></p>
                        </div>
                    </li>
                
            </ul>
        </div>
    </div>

    
		
    <div class="widget-wrap">
        <h3 class="widget-title">分类</h3>
        <div class="widget">
            <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Spring学习笔记/">Spring学习笔记</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Spring源码深度解析/">Spring源码深度解析</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/个人博客/">个人博客</a><span class="category-list-count">1</span></li></ul>
        </div>
    </div>

    
		
    <div class="widget-wrap">
        <h3 class="widget-title">标签</h3>
        <div class="widget">
            <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/AspectJ/">AspectJ</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Spring-IOC源码解析/">Spring IOC源码解析</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/SpringAOP/">SpringAOP</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Spring容器实现/">Spring容器实现</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Spring源码深度解析/">Spring源码深度解析</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Spring源码环境搭建/">Spring源码环境搭建</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Spring配置加载/">Spring配置加载</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Spring默认标签解析/">Spring默认标签解析</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/心灵鸡汤/">心灵鸡汤</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/面向切面编程/">面向切面编程</a><span class="tag-list-count">1</span></li></ul>
        </div>
    </div>

    
		
    <div class="widget-wrap">
        <h3 class="widget-title">标签云</h3>
        <div class="widget tagcloud">
            <a href="/tags/AspectJ/" style="font-size: 10px;">AspectJ</a> <a href="/tags/Spring-IOC源码解析/" style="font-size: 15px;">Spring IOC源码解析</a> <a href="/tags/SpringAOP/" style="font-size: 10px;">SpringAOP</a> <a href="/tags/Spring容器实现/" style="font-size: 10px;">Spring容器实现</a> <a href="/tags/Spring源码深度解析/" style="font-size: 20px;">Spring源码深度解析</a> <a href="/tags/Spring源码环境搭建/" style="font-size: 10px;">Spring源码环境搭建</a> <a href="/tags/Spring配置加载/" style="font-size: 10px;">Spring配置加载</a> <a href="/tags/Spring默认标签解析/" style="font-size: 10px;">Spring默认标签解析</a> <a href="/tags/心灵鸡汤/" style="font-size: 10px;">心灵鸡汤</a> <a href="/tags/面向切面编程/" style="font-size: 10px;">面向切面编程</a>
        </div>
    </div>

    
		
    <div class="widget-wrap widget-list">
        <h3 class="widget-title">链接</h3>
        <div class="widget">
            <ul>
                
                    <li>
                        <a href="http://blog.csdn.net/robertohuang">我的CSDN博客</a>
                    </li>
                
            </ul>
        </div>
    </div>


    
    <div id="toTop" class="fa fa-angle-up"></div>
</aside>

            
        </div>
        <footer id="footer">
	<script>
		var _hmt = _hmt || [];
		(function() {
		  var hm = document.createElement("script");
		  hm.src = "https://hm.baidu.com/hm.js?574bd75cb6b87036d89fc0c072f86ee9";
		  var s = document.getElementsByTagName("script")[0]; 
		  s.parentNode.insertBefore(hm, s);
		})();
	</script>
    <div class="outer" style="max-width:none">
        <div id="footer-info" class="inner">
            &copy; 2018 黄太洪<br>
            <a href="http://www.miibeian.gov.cn">沪ICP备13043688号</a> Powered by <a href="" target="_blank">黄太洪</a>. 
        </div>
    </div>
</footer>
        
    
    <script id="cy_cmt_num" src="https://changyan.sohu.com/upload/plugins/plugins.list.count.js?clientId=cytmLerJg"></script>
    <script charset="utf-8" type="text/javascript" src="https://changyan.sohu.com/upload/changyan.js" ></script>
    <script type="text/javascript">
    window.changyan.api.config({
    appid: 'cytmLerJg',
    conf: '599cd31eb2a680e5a4beb603cee26219'
    });
    </script>




    
        <script src="/libs/lightgallery/js/lightgallery.min.js"></script>
        <script src="/libs/lightgallery/js/lg-thumbnail.min.js"></script>
        <script src="/libs/lightgallery/js/lg-pager.min.js"></script>
        <script src="/libs/lightgallery/js/lg-autoplay.min.js"></script>
        <script src="/libs/lightgallery/js/lg-fullscreen.min.js"></script>
        <script src="/libs/lightgallery/js/lg-zoom.min.js"></script>
        <script src="/libs/lightgallery/js/lg-hash.min.js"></script>
        <script src="/libs/lightgallery/js/lg-share.min.js"></script>
        <script src="/libs/lightgallery/js/lg-video.min.js"></script>
    
    
        <script src="/libs/justified-gallery/jquery.justifiedGallery.min.js"></script>
    
    



<!-- Custom Scripts -->
<script src="/js/main.js"></script>

    </div>
</body>
</html>